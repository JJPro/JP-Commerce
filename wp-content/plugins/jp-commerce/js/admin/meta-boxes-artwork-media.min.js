jQuery(function(d){function x(a){var b=C/a.w,c=D/a.h;u.css({width:Math.round(b*v)+"px",height:Math.round(c*y)+"px",marginLeft:"-"+Math.round(b*a.x)+"px",marginTop:"-"+Math.round(c*a.y)+"px"});d('input[name="coord[x]"]').val(a.x*m);d('input[name="coord[y]"]').val(a.y*m);d('input[name="coord[w]"]').val(a.w*m);d('input[name="coord[h]"]').val(a.h*m)}function E(){g.Jcrop({onSelect:x,onChange:x,aspectRatio:1},function(){n=this;n.animateTo([42,100,192,250]);var a=n.getBounds();v=a[0];y=a[1];m=g[0].naturalWidth/
v})}function F(){e.on("addedfile",function(a){l.append(d("#upload-indicator-wrap"))});e.on("removedfile",function(a){5!==e.options.maxFiles&&e.options.maxFiles++;4==this.files.length&&(l.removeClass("dz-max-files-reached"),this.enable());a.hasOwnProperty("file_id")&&h.deleted_files.push(a.file_id)});e.on("totaluploadprogress",function(a){a=parseInt(a)+"%";G.css("width",a);H.text(a)});e.on("maxfilesexceeded",function(a){this.removeFile(a)});e.on("sending",function(a,b,c){debugger;var z=h.updated_files,
d=z.length,e;if(a.hasOwnProperty("file_id"))for(b=0;b<d;b++)e=z[b],e.file_id===a.file_id&&(c.append("action","jp_commerce_update_artwork_file_order"),c.append("artwork",artwork),c.append("file_id",e.file_id),c.append("file_order",e.order),c.append("nonce",q));else c.append("action","jp_commerce_add_artwork_file"),c.append("artwork",artwork),c.append("file_order",a.order),c.append("nonce",q)});e.on("queuecomplete",function(){if(0!==k.length){var a;f=!1;k.map(function(b){a=k[b];p(a)})}else f=!0,r.dialog("close"),
d("form").trigger("submit")});e.on("success",function(a,b){b.success||(f=!1,k.push(b.data))});e.on("error",function(a,b){A(b)})}function I(){var a=other_thumbnails.length,b,c;e.options.maxFiles-=a;for(var d=0;d<a;d++)b=other_thumbnails[d],c={name:b.id,size:0,file_id:b.id,order:b.order},e.files.push(c),e.emit("addedfile",c),e.emit("thumbnail",c,b.url);0===e.options.maxFiles&&l.addClass("dz-max-files-reached")}function A(a){d("<li>Error: "+a+"</li>").appendTo(J).effect("shake",{direction:"right"}).delay(8E3).fadeOut()}
function p(a){d("<li>Error: "+a+"</li>").appendTo(K).effect("shake",{direction:"right"})}function t(){return 0===h.added_files.length&&0===h.updated_files.length&&0===h.deleted_files.length}function L(){var a=h.deleted_files,b,c=a.length,e;if(0!==c){for(b=0;b<c;b++)e=a[b],d.ajax(w,{data:{artwork:artwork,file_id:e,nonce:q,action:"jp_commerce_delete_artwork_file"},type:"POST",error:function(a,b,c){f=!1;k.push(c);p(c)},success:function(a,b,c){a.success||(a=a.data,f=!1,k.push(a),p(a))}});h.deleted_files=
[];0===k.length&&(f=!0);f&&t()&&r.dialog("close")}}function M(){var a=h.updated_files,b,c=a.length,e,g;if(0!==c){for(b=0;b<c;b++)e=a[b].file_id,g=a[b].order,d.ajax(w,{data:{action:"jp_commerce_update_artwork_file_order",artwork:artwork,file_id:e,file_order:g,nonce:q},type:"POST",error:function(a,b,c){f=!1;k.push(c);p(c)},success:function(a,b,c){a.success||(a=a.data,f=!1,k.push(a),p(a))}});h.updated_files=[];0===k.length&&(f=!0);f&&t()&&r.dialog("close")}}d(window).on("dragover",function(a){a=a||event;
a.preventDefault()});d(window).on("drop",function(a){a=a||event;a.preventDefault()});var N=d("#cover-image-upload"),g=d("#cover-preview"),B=d("#wechat-preview-container"),u=d("#wechat-preview"),C=B.width(),D=B.height(),v,y,m,n;d("#btn-update-cover").on("click",function(a){a.preventDefault();d("#cover-input").trigger("click").on("change",function(a){if(""!=this.value){a=this.files[0];var c=new FileReader;c.onloadend=function(){var a=c.result;u.attr("src",a);n?(n.destroy(),g.remove(),g=d('<img id="cover-preview" style="width:100%; height:auto;" />'),
g.attr("src",c.result),g.appendTo(N)):(g.attr("src",a),g.css("display","initial"),u.css("display","initial"));E()};c.readAsDataURL(a)}})});var l=d("#media-upload-wrap"),K=d("#media-upload-errors ul"),q=l.attr("data-nonce"),r=d("#file-processing-modal"),G=d("#progress-bar"),H=d("#progress-text"),J=d("#dropzone-local-errors"),w=jc_data.ajaxurl,e=null,h={added_files:[],updated_files:[],deleted_files:[]},k=[],f=!1;(function(){Dropzone.autoDiscover=!1;Dropzone.prototype.addFile=function(a){if(this.files.length){var b,
c;b=0;for(c=this.files.length;b<c;b++)if(this.files[b].name===a.name&&this.files[b].size===a.size)return A("File with the same name already exists."),!1}a.upload={progress:0,total:a.size,bytesSent:0};this.files.push(a);a.status=Dropzone.ADDED;this.emit("addedfile",a);this._enqueueThumbnail(a);return this.accept(a,function(b){return function(c){c?(a.accepted=!1,b._errorProcessing([a],c)):(a.accepted=!0,b.options.autoQueue&&b.enqueueFile(a));return b._updateMaxFilesReachedClass()}}(this))}})();(function(){l.dropzone({url:w,
method:"post",maxFiles:5,parallelUploads:6,acceptedFiles:"image/*",autoProcessQueue:!1,uploadMultiple:!1,previewTemplate:'<div class="dz-preview dz-file-preview">   <div class="dz-details">       <img data-dz-thumbnail />   </div>   <div class="controls">       <i class="dz-remove icon-x-circle" data-dz-remove title="Delete"></i>   </div></div> ',clickable:".dz-clickable",dictInvalidFileType:"Only images are allowed.",dictResponseError:"Upload Failed. \nError Code: {{statusCode}}.",dictMaxFilesExceeded:"Exceeded number of files allowed.",
init:function(){e=this;window.dropzone_api=this;F();I();var a,b;l.sortable({items:".dz-preview",containment:"parent",distance:20,tolerance:"pointer",start:function(b,d){a=d.item.index(".dz-preview")},update:function(c,d){b=d.item.index(".dz-preview");e.files.move(a,b)}});Array.prototype.move=function(a,b){this.splice(b,0,this.splice(a,1)[0])}}})})();(function(){d("form").on("submit",function(a){a=e.files;for(var b,c=0,d=a.length;c<d;c++)(b=a[c],b.hasOwnProperty("order"))?b.hasOwnProperty("order")&&
c!==b.order&&(b.order=c,h.updated_files.push({file_id:b.file_id,order:c})):(b.order=c,h.added_files.push(c));if(f||t())return!0;t()||(r.dialog({modal:!0,dialogClass:"noTitleStuff fixed-dialog"}),L(),M(),e.processQueue());return!1})})()});
