window.wp=window.wp||{};
(function(g){var b;b=wp.revisions={model:{},view:{},controller:{}};b.settings=window._wpRevisionsSettings||{};b.debug=!1;b.log=function(){window.console&&b.debug&&window.console.log.apply(window.console,arguments)};g.fn.allOffsets=function(){var a=this.offset()||{top:0,left:0},c=g(window);return _.extend(a,{right:c.width()-a.left-this.outerWidth(),bottom:c.height()-a.top-this.outerHeight()})};g.fn.allPositions=function(){var a=this.position()||{top:0,left:0},c=this.parent();return _.extend(a,{right:c.outerWidth()-
a.left-this.outerWidth(),bottom:c.outerHeight()-a.top-this.outerHeight()})};b.model.Slider=Backbone.Model.extend({defaults:{value:null,values:null,min:0,max:1,step:1,range:!1,compareTwoMode:!1},initialize:function(a){this.frame=a.frame;this.revisions=a.revisions;this.listenTo(this.frame,"update:revisions",this.receiveRevisions);this.listenTo(this.frame,"change:compareTwoMode",this.updateMode);this.on("change:from",this.handleLocalChanges);this.on("change:to",this.handleLocalChanges);this.on("change:compareTwoMode",
this.updateSliderSettings);this.on("update:revisions",this.updateSliderSettings);this.on("change:hoveredRevision",this.hoverRevision);this.set({max:this.revisions.length-1,compareTwoMode:this.frame.get("compareTwoMode"),from:this.frame.get("from"),to:this.frame.get("to")});this.updateSliderSettings()},getSliderValue:function(a,c){return isRtl?this.revisions.length-this.revisions.indexOf(this.get(a))-1:this.revisions.indexOf(this.get(c))},updateSliderSettings:function(){this.get("compareTwoMode")?
this.set({values:[this.getSliderValue("to","from"),this.getSliderValue("from","to")],value:null,range:!0}):this.set({value:this.getSliderValue("to","to"),values:null,range:!1});this.trigger("update:slider")},hoverRevision:function(a,c){this.trigger("hovered:revision",c)},updateMode:function(a,c){this.set({compareTwoMode:c})},handleLocalChanges:function(){this.frame.set({from:this.get("from"),to:this.get("to")})},receiveRevisions:function(a,c){if(this.get("from")!==a||this.get("to")!==c)this.set({from:a,
to:c},{silent:!0}),this.trigger("update:revisions",a,c)}});b.model.Tooltip=Backbone.Model.extend({defaults:{revision:null,offset:{},hovering:!1,scrubbing:!1},initialize:function(a){this.frame=a.frame;this.revisions=a.revisions;this.slider=a.slider;this.listenTo(this.slider,"hovered:revision",this.updateRevision);this.listenTo(this.slider,"change:hovering",this.setHovering);this.listenTo(this.slider,"change:scrubbing",this.setScrubbing)},updateRevision:function(a){this.set({revision:a})},setHovering:function(a,
c){this.set({hovering:c})},setScrubbing:function(a,c){this.set({scrubbing:c})}});b.model.Revision=Backbone.Model.extend({});b.model.Revisions=Backbone.Collection.extend({model:b.model.Revision,initialize:function(){_.bindAll(this,"next","prev")},next:function(a){a=this.indexOf(a);if(-1!==a&&a!==this.length-1)return this.at(a+1)},prev:function(a){a=this.indexOf(a);if(-1!==a&&0!==a)return this.at(a-1)}});b.model.Field=Backbone.Model.extend({});b.model.Fields=Backbone.Collection.extend({model:b.model.Field});
b.model.Diff=Backbone.Model.extend({initialize:function(){var a=this.get("fields");this.unset("fields");this.fields=new b.model.Fields(a)}});b.model.Diffs=Backbone.Collection.extend({initialize:function(a,c){_.bindAll(this,"getClosestUnloaded");this.loadAll=_.once(this._loadAll);this.revisions=c.revisions;this.postId=c.postId;this.requests={}},model:b.model.Diff,ensure:function(a,c){var d=this.get(a),b=this.requests[a],f=g.Deferred(),h={},k=a.split(":")[0],l=a.split(":")[1];h[a]=!0;wp.revisions.log("ensure",
a);this.trigger("ensure",h,k,l,f.promise());d?f.resolveWith(c,[d]):(this.trigger("ensure:load",h,k,l,f.promise()),_.each(h,_.bind(function(a){this.requests[a]&&delete h[a];this.get(a)&&delete h[a]},this)),b||(h[a]=!0,b=this.load(_.keys(h))),b.done(_.bind(function(){f.resolveWith(c,[this.get(a)])},this)).fail(_.bind(function(){f.reject()})));return f.promise()},getClosestUnloaded:function(a,c){var d=this;return _.chain([0].concat(a)).initial().zip(a).sortBy(function(a){return Math.abs(c-a[1])}).map(function(a){return a.join(":")}).filter(function(a){return _.isUndefined(d.get(a))&&
!d.requests[a]}).value()},_loadAll:function(a,c,d){var b=this,f=g.Deferred(),h=_.first(this.getClosestUnloaded(a,c),d);0<_.size(h)?this.load(h).done(function(){b._loadAll(a,c,d).done(function(){f.resolve()})}).fail(function(){1===d?f.reject():b._loadAll(a,c,Math.ceil(d/2)).done(function(){f.resolve()})}):f.resolve();return f},load:function(a){wp.revisions.log("load",a);return this.fetch({data:{compare:a},remove:!1}).done(function(){wp.revisions.log("load:complete",a)})},sync:function(a,c,d){if("read"===
a){d=d||{};d.context=this;d.data=_.extend(d.data||{},{action:"get-revision-diffs",post_id:this.postId});var b=wp.ajax.send(d),f=this.requests;d.data.compare&&_.each(d.data.compare,function(a){f[a]=b});b.always(function(){d.data.compare&&_.each(d.data.compare,function(a){delete f[a]})});return b}return Backbone.Model.prototype.sync.apply(this,arguments)}});b.model.FrameState=Backbone.Model.extend({defaults:{loading:!1,error:!1,compareTwoMode:!1},initialize:function(a,c){var d=this.get("initialDiffState");
_.bindAll(this,"receiveDiff");this._debouncedEnsureDiff=_.debounce(this._ensureDiff,200);this.revisions=c.revisions;this.diffs=new b.model.Diffs([],{revisions:this.revisions,postId:this.get("postId")});this.diffs.set(this.get("diffData"));this.listenTo(this,"change:from",this.changeRevisionHandler);this.listenTo(this,"change:to",this.changeRevisionHandler);this.listenTo(this,"change:compareTwoMode",this.changeMode);this.listenTo(this,"update:revisions",this.updatedRevisions);this.listenTo(this.diffs,
"ensure:load",this.updateLoadingStatus);this.listenTo(this,"update:diff",this.updateLoadingStatus);this.set({to:this.revisions.get(d.to),from:this.revisions.get(d.from),compareTwoMode:d.compareTwoMode});window.history&&window.history.pushState&&(this.router=new b.Router({model:this}),Backbone.history.start({pushState:!0}))},updateLoadingStatus:function(){this.set("error",!1);this.set("loading",!this.diff())},changeMode:function(a,c){var d=this.revisions.indexOf(this.get("to"));c&&0===d&&this.set({from:this.revisions.at(d),
to:this.revisions.at(d+1)});c||0===d||this.set({from:this.revisions.at(d-1),to:this.revisions.at(d)})},updatedRevisions:function(a,c){this.get("compareTwoMode")||this.diffs.loadAll(this.revisions.pluck("id"),c.id,40)},diff:function(){return this.diffs.get(this._diffId)},updateDiff:function(a){var c,d,b;a=a||{};c=this.get("from");d=this.get("to");b=(c?c.id:0)+":"+d.id;if(this._diffId===b)return g.Deferred().reject().promise();this._diffId=b;this.trigger("update:revisions",c,d);if(c=this.diffs.get(b))return this.receiveDiff(c),
g.Deferred().resolve().promise();if(a.immediate)return this._ensureDiff();this._debouncedEnsureDiff();return g.Deferred().reject().promise()},changeRevisionHandler:function(){this.updateDiff()},receiveDiff:function(a){_.isUndefined(a)||_.isUndefined(a.id)?this.set({loading:!1,error:!0}):this._diffId===a.id&&this.trigger("update:diff",a)},_ensureDiff:function(){return this.diffs.ensure(this._diffId,this).always(this.receiveDiff)}});b.view.Frame=wp.Backbone.View.extend({className:"revisions",template:wp.template("revisions-frame"),
initialize:function(){this.listenTo(this.model,"update:diff",this.renderDiff);this.listenTo(this.model,"change:compareTwoMode",this.updateCompareTwoMode);this.listenTo(this.model,"change:loading",this.updateLoadingStatus);this.listenTo(this.model,"change:error",this.updateErrorStatus);this.views.set(".revisions-control-frame",new b.view.Controls({model:this.model}))},render:function(){wp.Backbone.View.prototype.render.apply(this,arguments);g("html").css("overflow-y","scroll");g("#wpbody-content .wrap").append(this.el);
this.updateCompareTwoMode();this.renderDiff(this.model.diff());this.views.ready();return this},renderDiff:function(a){this.views.set(".revisions-diff-frame",new b.view.Diff({model:a}))},updateLoadingStatus:function(){this.$el.toggleClass("loading",this.model.get("loading"))},updateErrorStatus:function(){this.$el.toggleClass("diff-error",this.model.get("error"))},updateCompareTwoMode:function(){this.$el.toggleClass("comparing-two-revisions",this.model.get("compareTwoMode"))}});b.view.Controls=wp.Backbone.View.extend({className:"revisions-controls",
initialize:function(){_.bindAll(this,"setWidth");this.views.add(new b.view.Buttons({model:this.model}));this.views.add(new b.view.Checkbox({model:this.model}));var a=new b.model.Slider({frame:this.model,revisions:this.model.revisions}),c=new b.model.Tooltip({frame:this.model,revisions:this.model.revisions,slider:a});this.views.add(new b.view.Tooltip({model:c}));this.views.add(new b.view.Tickmarks({model:c}));this.views.add(new b.view.Slider({model:a}));this.views.add(new b.view.Metabox({model:this.model}))},
ready:function(){this.top=this.$el.offset().top;this.window=g(window);this.window.on("scroll.wp.revisions",{controls:this},function(a){a=a.data.controls;var c=a.$el.parent(),b=a.window.scrollTop(),e=a.views.parent;b>=a.top?(e.$el.hasClass("pinned")||(a.setWidth(),c.css("height",c.height()+"px"),a.window.on("resize.wp.revisions.pinning click.wp.revisions.pinning",{controls:a},function(a){a.data.controls.setWidth()})),e.$el.addClass("pinned")):(e.$el.hasClass("pinned")&&(a.window.off(".wp.revisions.pinning"),
a.$el.css("width","auto"),e.$el.removeClass("pinned"),c.css("height","auto")),a.top=a.$el.offset().top)})},setWidth:function(){this.$el.css("width",this.$el.parent().width()+"px")}});b.view.Tickmarks=wp.Backbone.View.extend({className:"revisions-tickmarks",direction:isRtl?"right":"left",initialize:function(){this.listenTo(this.model,"change:revision",this.reportTickPosition)},reportTickPosition:function(a,c){var b,e,f,g;b=this.model.revisions.indexOf(c);e=this.$el.allOffsets();f=this.$el.parent().allOffsets();
b===this.model.revisions.length-1?b={rightPlusWidth:e.left-f.left+1,leftPlusWidth:e.right-f.right+1}:(g=this.$("div:nth-of-type("+(b+1)+")"),b=g.allPositions(),_.extend(b,{left:b.left+e.left-f.left,right:b.right+e.right-f.right}),_.extend(b,{leftPlusWidth:b.left+g.outerWidth(),rightPlusWidth:b.right+g.outerWidth()}));this.model.set({offset:b})},ready:function(){var a,c;a=this.model.revisions.length-1;c=1/a;this.$el.css("width",50*this.model.revisions.length+"px");_(a).times(function(a){this.$el.append('<div style="'+
this.direction+": "+100*c*a+'%"></div>')},this)}});b.view.Metabox=wp.Backbone.View.extend({className:"revisions-meta",initialize:function(){this.views.add(new b.view.MetaFrom({model:this.model,className:"diff-meta diff-meta-from"}));this.views.add(new b.view.MetaTo({model:this.model}))}});b.view.Meta=wp.Backbone.View.extend({template:wp.template("revisions-meta"),events:{"click .restore-revision":"restoreRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.render)},prepare:function(){return _.extend(this.model.toJSON()[this.type]||
{},{type:this.type})},restoreRevision:function(){document.location=this.model.get("to").attributes.restoreUrl}});b.view.MetaFrom=b.view.Meta.extend({className:"diff-meta diff-meta-from",type:"from"});b.view.MetaTo=b.view.Meta.extend({className:"diff-meta diff-meta-to",type:"to"});b.view.Checkbox=wp.Backbone.View.extend({className:"revisions-checkbox",template:wp.template("revisions-checkbox"),events:{"click .compare-two-revisions":"compareTwoToggle"},initialize:function(){this.listenTo(this.model,
"change:compareTwoMode",this.updateCompareTwoMode)},ready:function(){3>this.model.revisions.length&&g(".revision-toggle-compare-mode").hide()},updateCompareTwoMode:function(){this.$(".compare-two-revisions").prop("checked",this.model.get("compareTwoMode"))},compareTwoToggle:function(){this.model.set({compareTwoMode:g(".compare-two-revisions").prop("checked")})}});b.view.Tooltip=wp.Backbone.View.extend({className:"revisions-tooltip",template:wp.template("revisions-meta"),initialize:function(){this.listenTo(this.model,
"change:offset",this.render);this.listenTo(this.model,"change:hovering",this.toggleVisibility);this.listenTo(this.model,"change:scrubbing",this.toggleVisibility)},prepare:function(){if(!_.isNull(this.model.get("revision")))return _.extend({type:"tooltip"},{attributes:this.model.get("revision").toJSON()})},render:function(){var a,c,b,e,f={};e=.5<(this.model.revisions.indexOf(this.model.get("revision"))+1)/this.model.revisions.length;isRtl?(c=e?"left":"right",b=e?"leftPlusWidth":c):(c=e?"right":"left",
b=e?"rightPlusWidth":c);a="right"===c?"left":"right";wp.Backbone.View.prototype.render.apply(this,arguments);f[c]=this.model.get("offset")[b]+"px";f[a]="";this.$el.toggleClass("flipped",e).css(f)},visible:function(){return this.model.get("scrubbing")||this.model.get("hovering")},toggleVisibility:function(){this.visible()?this.$el.stop().show().fadeTo(100-100*this.el.style.opacity,1):this.$el.stop().fadeTo(300*this.el.style.opacity,0,function(){g(this).hide()})}});b.view.Buttons=wp.Backbone.View.extend({className:"revisions-buttons",
template:wp.template("revisions-buttons"),events:{"click .revisions-next .button":"nextRevision","click .revisions-previous .button":"previousRevision"},initialize:function(){this.listenTo(this.model,"update:revisions",this.disabledButtonCheck)},ready:function(){this.disabledButtonCheck()},gotoModel:function(a){var b={to:this.model.revisions.at(a)};a?b.from=this.model.revisions.at(a-1):this.model.unset("from",{silent:!0});this.model.set(b)},nextRevision:function(){var a=this.model.revisions.indexOf(this.model.get("to"))+
1;this.gotoModel(a)},previousRevision:function(){var a=this.model.revisions.indexOf(this.model.get("to"))-1;this.gotoModel(a)},disabledButtonCheck:function(){var a=this.model.revisions.length-1,b=g(".revisions-next .button"),d=g(".revisions-previous .button"),e=this.model.revisions.indexOf(this.model.get("to"));b.prop("disabled",a===e);d.prop("disabled",0===e)}});b.view.Slider=wp.Backbone.View.extend({className:"wp-slider",direction:isRtl?"right":"left",events:{mousemove:"mouseMove"},initialize:function(){_.bindAll(this,
"start","slide","stop","mouseMove","mouseEnter","mouseLeave");this.listenTo(this.model,"update:slider",this.applySliderSettings)},ready:function(){this.$el.css("width",50*this.model.revisions.length+"px");this.$el.slider(_.extend(this.model.toJSON(),{start:this.start,slide:this.slide,stop:this.stop}));this.$el.hoverIntent({over:this.mouseEnter,out:this.mouseLeave,timeout:800});this.applySliderSettings()},mouseMove:function(a){var b=this.model.revisions.length-1,d=this.$el.allOffsets()[this.direction],
b=this.$el.width()/b;a=(isRtl?g(window).width()-a.pageX:a.pageX)-d;a=Math.floor((a+b/2)/b);0>a?a=0:a>=this.model.revisions.length&&(a=this.model.revisions.length-1);this.model.set({hoveredRevision:this.model.revisions.at(a)})},mouseLeave:function(){this.model.set({hovering:!1})},mouseEnter:function(){this.model.set({hovering:!0})},applySliderSettings:function(){this.$el.slider(_.pick(this.model.toJSON(),"value","values","range"));var a=this.$("a.ui-slider-handle");this.model.get("compareTwoMode")?
(a.first().toggleClass("to-handle",!!isRtl).toggleClass("from-handle",!isRtl),a.last().toggleClass("from-handle",!!isRtl).toggleClass("to-handle",!isRtl)):a.removeClass("from-handle to-handle")},start:function(a,b){this.model.set({scrubbing:!0});g(window).on("mousemove.wp.revisions",{view:this},function(a){var e;e=a.data.view;var f=e.$el.offset().left,h=f,k=f+e.$el.width(),l="0",n="100%",m=g(b.handle);e.model.get("compareTwoMode")&&(e=m.parent().find(".ui-slider-handle"),m.is(e.first())?(k=e.last().offset().left,
n=k-h):(f=e.first().offset().left+e.first().width(),l=f-h));a.pageX<f?m.css("left",l):a.pageX>k?m.css("left",n):m.css("left",a.pageX-h)})},getPosition:function(a){return isRtl?this.model.revisions.length-a-1:a},slide:function(a,b){var d,e;if(this.model.get("compareTwoMode")){if(b.values[1]===b.values[0])return!1;isRtl&&b.values.reverse();d={from:this.model.revisions.at(this.getPosition(b.values[0])),to:this.model.revisions.at(this.getPosition(b.values[1]))}}else d={to:this.model.revisions.at(this.getPosition(b.value))},
0<this.getPosition(b.value)?d.from=this.model.revisions.at(this.getPosition(b.value)-1):d.from=void 0;e=this.model.revisions.at(this.getPosition(b.value));this.model.get("scrubbing")&&(d.hoveredRevision=e);this.model.set(d)},stop:function(){g(window).off("mousemove.wp.revisions");this.model.updateSliderSettings();this.model.set({scrubbing:!1})}});b.view.Diff=wp.Backbone.View.extend({className:"revisions-diff",template:wp.template("revisions-diff"),prepare:function(){return _.extend({fields:this.model.fields.toJSON()},
this.options)}});b.Router=Backbone.Router.extend({initialize:function(a){this.model=a.model;this.listenTo(this.model,"update:diff",_.debounce(this.updateUrl,250));this.listenTo(this.model,"change:compareTwoMode",this.updateUrl)},baseUrl:function(a){return this.model.get("baseUrl")+a},updateUrl:function(){var a=this.model.has("from")?this.model.get("from").id:0,b=this.model.get("to").id;this.model.get("compareTwoMode")?this.navigate(this.baseUrl("?from="+a+"&to="+b),{replace:!0}):this.navigate(this.baseUrl("?revision="+
b),{replace:!0})},handleRoute:function(a,b){_.isUndefined(b)||(b=this.model.revisions.get(a),this.model.revisions.prev(b))}});b.init=function(){var a;window.adminpage&&"revision-php"===window.adminpage&&(a=new b.model.FrameState({initialDiffState:{to:parseInt(b.settings.to,10),from:parseInt(b.settings.from,10),compareTwoMode:"1"===b.settings.compareTwoMode},diffData:b.settings.diffData,baseUrl:b.settings.baseUrl,postId:parseInt(b.settings.postId,10)},{revisions:new b.model.Revisions(b.settings.revisionData)}),
b.view.frame=(new b.view.Frame({model:a})).render())};g(b.init)})(jQuery);
