(function(c){var k=window.imageEdit={iasapi:{},hold:{},postid:"",_view:!1,intval:function(a){return a|0},setDisabled:function(a,d){d?(a.removeClass("disabled"),c("input",a).removeAttr("disabled")):(a.addClass("disabled"),c("input",a).prop("disabled",!0))},init:function(a){var d=c("#image-editor-"+this.postid),e=this.intval(c("#imgedit-x-"+a).val()),b=this.intval(c("#imgedit-y-"+a).val());this.postid!==a&&d.length&&this.close(this.postid);this.hold.w=this.hold.ow=e;this.hold.h=this.hold.oh=b;this.hold.xy_ratio=
e/b;this.hold.sizer=parseFloat(c("#imgedit-sizer-"+a).val());this.postid=a;c("#imgedit-response-"+a).empty();c('input[type="text"]',"#imgedit-panel-"+a).keypress(function(a){var b=a.keyCode;36<b&&41>b&&c(this).blur();if(13===b)return a.preventDefault(),a.stopPropagation(),!1})},toggleEditor:function(a,d){var e=c("#imgedit-wait-"+a);d?e.height(c("#imgedit-panel-"+a).height()).fadeIn("fast"):e.fadeOut("fast")},toggleHelp:function(a){c(a).parents(".imgedit-group-top").toggleClass("imgedit-help-toggled").find(".imgedit-help").slideToggle("fast");
return!1},getTarget:function(a){return c('input[name="imgedit-target-'+a+'"]:checked',"#imgedit-save-target-"+a).val()||"full"},scaleChanged:function(a,d){var e=c("#imgedit-scale-width-"+a),b=c("#imgedit-scale-height-"+a),f=c("#imgedit-scale-warn-"+a),g="",h="";d?(h=""!==e.val()?Math.round(e.val()/this.hold.xy_ratio):"",b.val(h)):(g=""!==b.val()?Math.round(b.val()*this.hold.xy_ratio):"",e.val(g));h&&h>this.hold.oh||g&&g>this.hold.ow?f.css("visibility","visible"):f.css("visibility","hidden")},getSelRatio:function(a){var d=
this.hold.w,e=this.hold.h,b=this.intval(c("#imgedit-crop-width-"+a).val());a=this.intval(c("#imgedit-crop-height-"+a).val());return b&&a?b+":"+a:d&&e?d+":"+e:"1:1"},filterHistory:function(a,d){var e=c("#imgedit-history-"+a).val(),b,f,g=[];if(""!==e){e=JSON.parse(e);b=this.intval(c("#imgedit-undone-"+a).val());if(0<b)for(;0<b;)e.pop(),b--;if(d){if(!e.length)return this.hold.w=this.hold.ow,this.hold.h=this.hold.oh,"";b=e[e.length-1];if(b=b.c||b.r||b.f||!1)this.hold.w=b.fw,this.hold.h=b.fh}for(f in e)b=
e[f],b.hasOwnProperty("c")?g[f]={c:{x:b.c.x,y:b.c.y,w:b.c.w,h:b.c.h}}:b.hasOwnProperty("r")?g[f]={r:b.r.r}:b.hasOwnProperty("f")&&(g[f]={f:b.f.f});return JSON.stringify(g)}return""},refreshEditor:function(a,d,e){var b=this,f;b.toggleEditor(a,1);d={action:"imgedit-preview",_ajax_nonce:d,postid:a,history:b.filterHistory(a,1),rand:b.intval(1E6*Math.random())};f=c('<img id="image-preview-'+a+'" />').on("load",function(){var b,d,p=c("#imgedit-crop-"+a),l=k;p.empty().append(f);b=Math.max(l.hold.w,l.hold.h);
d=Math.max(c(f).width(),c(f).height());l.hold.sizer=b>d?d/b:1;l.initCrop(a,f,p);l.setCropSelection(a,0);"undefined"!==typeof e&&null!==e&&e();c("#imgedit-history-"+a).val()&&"0"===c("#imgedit-undone-"+a).val()?c("input.imgedit-submit-btn","#imgedit-panel-"+a).removeAttr("disabled"):c("input.imgedit-submit-btn","#imgedit-panel-"+a).prop("disabled",!0);l.toggleEditor(a,0)}).on("error",function(){c("#imgedit-crop-"+a).empty().append('<div class="error"><p>'+imageEditL10n.error+"</p></div>");b.toggleEditor(a,
0)}).attr("src",ajaxurl+"?"+c.param(d))},action:function(a,d,e){var b=this,f,g,h;if(b.notsaved(a))return!1;d={action:"image-editor",_ajax_nonce:d,postid:a};if("scale"===e){e=c("#imgedit-scale-width-"+a);f=c("#imgedit-scale-height-"+a);g=b.intval(e.val());h=b.intval(f.val());if(1>g)return e.focus(),!1;if(1>h)return f.focus(),!1;if(g===b.hold.ow||h===b.hold.oh)return!1;d["do"]="scale";d.fwidth=g;d.fheight=h}else if("restore"===e)d["do"]="restore";else return!1;b.toggleEditor(a,1);c.post(ajaxurl,d,function(d){c("#image-editor-"+
a).empty().append(d);b.toggleEditor(a,0);b._view&&b._view.refresh()})},save:function(a,d){var e;e=this.getTarget(a);var b=this.filterHistory(a,0),f=this;if(""===b)return!1;this.toggleEditor(a,1);e={action:"image-editor",_ajax_nonce:d,postid:a,history:b,target:e,context:c("#image-edit-context").length?c("#image-edit-context").val():null,"do":"save"};c.post(ajaxurl,e,function(b){b=JSON.parse(b);b.error?(c("#imgedit-response-"+a).html('<div class="error"><p>'+b.error+"</p></div>"),k.close(a)):(b.fw&&
b.fh&&c("#media-dims-"+a).html(b.fw+" &times; "+b.fh),b.thumbnail&&c(".thumbnail","#thumbnail-head-"+a).attr("src",""+b.thumbnail),b.msg&&c("#imgedit-response-"+a).html('<div class="updated"><p>'+b.msg+"</p></div>"),f._view?f._view.save():k.close(a))})},open:function(a,d,e){this._view=e;var b=c("#image-editor-"+a),f=c("#media-head-"+a),g=c("#imgedit-open-btn-"+a),h=g.siblings(".spinner");g.prop("disabled",!0);h.addClass("is-active");return c.ajax({url:ajaxurl,type:"post",data:{action:"image-editor",
_ajax_nonce:d,postid:a,"do":"open"}}).done(function(a){b.html(a);f.fadeOut("fast",function(){b.fadeIn("fast");g.removeAttr("disabled");h.removeClass("is-active")})})},imgLoaded:function(a){var d=c("#image-preview-"+a),e=c("#imgedit-crop-"+a);this.initCrop(a,d,e);this.setCropSelection(a,0);this.toggleEditor(a,0)},initCrop:function(a,d,e){var b=this,f=c("#imgedit-sel-width-"+a),g=c("#imgedit-sel-height-"+a),h;b.iasapi=c(d).imgAreaSelect({parent:e,instance:!0,handles:!0,keys:!0,minWidth:3,minHeight:3,
onInit:function(d){h=c(d);h.next().css("position","absolute").nextAll(".imgareaselect-outer").css("position","absolute");e.children().mousedown(function(c){var d=!1;c.shiftKey&&(c=b.iasapi.getSelection(),d=b.getSelRatio(a),d=c&&c.width&&c.height?c.width+":"+c.height:d);b.iasapi.setOptions({aspectRatio:d})})},onSelectStart:function(){k.setDisabled(c("#imgedit-crop-sel-"+a),1)},onSelectEnd:function(b,c){k.setCropSelection(a,c)},onSelectChange:function(a,b){var c=k.hold.sizer;f.val(k.round(b.width/c));
g.val(k.round(b.height/c))}})},setCropSelection:function(a,d){var e;d=d||0;if(!d||3>d.width&&3>d.height)return this.setDisabled(c(".imgedit-crop","#imgedit-panel-"+a),0),this.setDisabled(c("#imgedit-crop-sel-"+a),0),c("#imgedit-sel-width-"+a).val(""),c("#imgedit-sel-height-"+a).val(""),c("#imgedit-selection-"+a).val(""),!1;e={x:d.x1,y:d.y1,w:d.width,h:d.height};this.setDisabled(c(".imgedit-crop","#imgedit-panel-"+a),1);c("#imgedit-selection-"+a).val(JSON.stringify(e))},close:function(a,d){if(d&&this.notsaved(a))return!1;
this.iasapi={};this.hold={};this._view?this._view.back():c("#image-editor-"+a).fadeOut("fast",function(){c("#media-head-"+a).fadeIn("fast");c(this).empty()})},notsaved:function(a){var d=c("#imgedit-history-"+a).val(),d=""!==d?JSON.parse(d):[];return this.intval(c("#imgedit-undone-"+a).val())<d.length?confirm(c("#imgedit-leaving-"+a).html())?!1:!0:!1},addStep:function(a,d,e){for(var b=this,f=c("#imgedit-history-"+d),g=""!==f.val()?JSON.parse(f.val()):[],h=c("#imgedit-undone-"+d),k=b.intval(h.val());0<
k;)g.pop(),k--;h.val(0);g.push(a);f.val(JSON.stringify(g));b.refreshEditor(d,e,function(){b.setDisabled(c("#image-undo-"+d),!0);b.setDisabled(c("#image-redo-"+d),!1)})},rotate:function(a,d,e,b){if(c(b).hasClass("disabled"))return!1;this.addStep({r:{r:a,fw:this.hold.h,fh:this.hold.w}},d,e)},flip:function(a,d,e,b){if(c(b).hasClass("disabled"))return!1;this.addStep({f:{f:a,fw:this.hold.w,fh:this.hold.h}},d,e)},crop:function(a,d,e){var b=c("#imgedit-selection-"+a).val(),f=this.intval(c("#imgedit-sel-width-"+
a).val()),g=this.intval(c("#imgedit-sel-height-"+a).val());if(c(e).hasClass("disabled")||""===b)return!1;b=JSON.parse(b);0<b.w&&0<b.h&&0<f&&0<g&&(b.fw=f,b.fh=g,this.addStep({c:b},a,d))},undo:function(a,d){var e=this,b=c("#image-undo-"+a),f=c("#imgedit-undone-"+a),g=e.intval(f.val())+1;b.hasClass("disabled")||(f.val(g),e.refreshEditor(a,d,function(){var d=c("#imgedit-history-"+a),d=""!==d.val()?JSON.parse(d.val()):[];e.setDisabled(c("#image-redo-"+a),!0);e.setDisabled(b,g<d.length)}))},redo:function(a,
d){var e=this,b=c("#image-redo-"+a),f=c("#imgedit-undone-"+a),g=e.intval(f.val())-1;b.hasClass("disabled")||(f.val(g),e.refreshEditor(a,d,function(){e.setDisabled(c("#image-undo-"+a),!0);e.setDisabled(b,0<g)}))},setNumSelection:function(a){var d,e=c("#imgedit-sel-width-"+a),b=c("#imgedit-sel-height-"+a),f=this.intval(e.val()),g=this.intval(b.val()),h=c("#image-preview-"+a),k=h.height(),h=h.width(),l=this.hold.sizer,m,n=this.iasapi;if(1>f)return e.val(""),!1;if(1>g)return b.val(""),!1;f&&g&&(d=n.getSelection())&&
(f=d.x1+Math.round(f*l),m=d.y1+Math.round(g*l),g=d.x1,d=d.y1,f>h&&(g=0,f=h,e.val(Math.round(f/l))),m>k&&(d=0,m=k,b.val(Math.round(m/l))),n.setSelection(g,d,f,m),n.update(),this.setCropSelection(a,n.getSelection()))},round:function(a){var c;a=Math.round(a);if(.6<this.hold.sizer)return a;c=a.toString().slice(-1);return"1"===c?a-1:"9"===c?a+1:a},setRatioSelection:function(a,d,e){var b;b=this.intval(c("#imgedit-crop-width-"+a).val());var f=this.intval(c("#imgedit-crop-height-"+a).val()),g=c("#image-preview-"+
a).height();this.intval(c(e).val())?b&&f&&(this.iasapi.setOptions({aspectRatio:b+":"+f}),e=this.iasapi.getSelection(!0))&&(b=Math.ceil(e.y1+(e.x2-e.x1)/(b/f)),b>g&&(b=g,d?c("#imgedit-crop-height-"+a).val(""):c("#imgedit-crop-width-"+a).val("")),this.iasapi.setSelection(e.x1,e.y1,e.x2,b),this.iasapi.update()):c(e).val("")}}})(jQuery);
