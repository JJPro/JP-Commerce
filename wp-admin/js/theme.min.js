window.wp=window.wp||{};
(function(c){var b,e;b=wp.themes=wp.themes||{};b.data=_wpThemeSettings;e=b.data.l10n;b.isInstall=!!b.data.settings.isInstall;_.extend(b,{model:{},view:{},routes:{},router:{},template:wp.template});b.Model=Backbone.Model.extend({initialize:function(){var a;-1!==_.indexOf(b.data.installedThemes,this.get("slug"))&&this.set({installed:!0});this.set({id:this.get("slug")||this.get("id")});this.has("sections")&&(a=this.get("sections").description,this.set({description:a}))}});b.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",
window:c(window),page:0,initialize:function(a){_.bindAll(this,"scroller");this.SearchView=a.SearchView?a.SearchView:b.view.Search;this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new b.view.Themes({collection:this.collection,parent:this});this.search();this.view.render();this.$el.empty().append(this.view.el).addClass("rendered");this.$el.append('<br class="clear"/>')},searchContainer:c("#wpbody h1:first"),search:function(){var a;1!==b.data.themes.length&&(a=new this.SearchView({collection:this.collection,
parent:this}),a.render(),this.searchContainer.append(c.parseHTML('<label class="screen-reader-text" for="wp-filter-search-input">'+e.search+"</label>")).append(a.el))},scroller:function(){var a,d;a=this.window.scrollTop()+this.window.height();d=this.$el.offset().top+this.$el.outerHeight(!1)-this.window.height();d=Math.round(.9*d);a>d&&this.trigger("theme:scroll")}});b.Collection=Backbone.Collection.extend({model:b.Model,terms:"",doSearch:function(a){this.terms!==a&&(this.terms=a,0<this.terms.length&&
this.search(this.terms),""===this.terms&&(this.reset(b.data.themes),c("body").removeClass("no-results")),this.trigger("update"))},search:function(a){var d,g,f,e,h,k;this.reset(b.data.themes,{silent:!0});a=a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");a=a.replace(/ /g,")(?=.*");d=new RegExp("^(?=.*"+a+").+","i");g=this.filter(function(b){e=b.get("name").replace(/(<([^>]+)>)/ig,"");h=b.get("description").replace(/(<([^>]+)>)/ig,"");k=b.get("author").replace(/(<([^>]+)>)/ig,"");f=_.union(e,b.get("id"),
h,k,b.get("tags"));d.test(b.get("author"))&&2<a.length&&b.set("displayAuthor",!0);return d.test(f)});0===g.length?this.trigger("query:empty"):c("body").removeClass("no-results");this.reset(g)},paginate:function(a){a=_(this.rest(20*(a||0)));return a=_(a.first(20))},count:!1,query:function(a){var d=this.queries,b=this,f,e,h;this.currentQuery.request=a;f=_.find(d,function(d){return _.isEqual(d.request,a)});e=_.has(a,"page");e||(this.currentQuery.page=1);if(f||e){if(e)return this.apiCall(a,e).done(function(a){b.add(a.themes);
b.trigger("query:success");b.loadingThemes=!1}).fail(function(){b.trigger("query:fail")});0===f.themes.length?b.trigger("query:empty"):c("body").removeClass("no-results");_.isNumber(f.total)&&(this.count=f.total);this.reset(f.themes);f.total||(this.count=this.length);this.trigger("update");this.trigger("query:success",this.count)}else f=this.apiCall(a).done(function(c){c.themes&&(b.reset(c.themes),h=c.info.results,d.push({themes:c.themes,request:a,total:h}));b.trigger("update");b.trigger("query:success",
h);c.themes&&0===c.themes.length&&b.trigger("query:empty")}).fail(function(){b.trigger("query:fail")})},queries:[],currentQuery:{page:1,request:{}},apiCall:function(a,d){return wp.ajax.send("query-themes",{data:{request:_.extend({per_page:100,fields:{description:!0,tested:!0,requires:!0,rating:!0,downloaded:!0,downloadLink:!0,last_updated:!0,homepage:!0,num_ratings:!0}},a)},beforeSend:function(){d||c("body").addClass("loading-content").removeClass("no-results")}})},loadingThemes:!1});b.view.Theme=
wp.Backbone.View.extend({className:"theme",state:"grid",html:b.template("theme"),events:{click:b.isInstall?"preview":"expand",keydown:b.isInstall?"preview":"expand",touchend:b.isInstall?"preview":"expand",keyup:"addFocus",touchmove:"preventExpand"},touchDrag:!1,render:function(){var a=this.model.toJSON();this.$el.html(this.html(a)).attr({tabindex:0,"aria-describedby":a.id+"-action "+a.id+"-name"});this.activeTheme();this.model.get("displayAuthor")&&this.$el.addClass("display-author");this.model.get("installed")&&
this.$el.addClass("is-installed")},activeTheme:function(){this.model.get("active")&&this.$el.addClass("active")},addFocus:function(){var a=c(":focus").hasClass("theme")?c(":focus"):c(":focus").parents(".theme");c(".theme.focus").removeClass("focus");a.addClass("focus")},expand:function(a){a=a||window.event;if("keydown"!==a.type||13===a.which||32===a.which){if(!0===this.touchDrag)return this.touchDrag=!1;c(a.target).is(".theme-actions a")||(b.focusedTheme=this.$el,this.trigger("theme:expand",this.model.cid))}},
preventExpand:function(){this.touchDrag=!0},preview:function(a){var d=this,g,f;if(!0===this.touchDrag)return this.touchDrag=!1;c(a.target).hasClass("button-primary")||"keydown"===a.type&&13!==a.which&&32!==a.which||"keydown"===a.type&&13!==a.which&&c(":focus").hasClass("button")||(a.preventDefault(),a=a||window.event,b.focusedTheme=this.$el,f=new b.view.Preview({model:this.model}),f.render(),this.setNavButtonsState(),1===this.model.collection.length?f.$el.addClass("no-navigation"):f.$el.removeClass("no-navigation"),
c("div.wrap").append(f.el),this.listenTo(f,"theme:next",function(){g=d.model;_.isUndefined(d.current)||(g=d.current);d.current=d.model.collection.at(d.model.collection.indexOf(g)+1);if(_.isUndefined(d.current))return d.options.parent.parent.trigger("theme:end"),d.current=g;f.model=d.current;f.render();this.setNavButtonsState();c(".next-theme").focus()}).listenTo(f,"theme:previous",function(){g=d.model;0!==d.model.collection.indexOf(d.current)&&(_.isUndefined(d.current)||(g=d.current),d.current=d.model.collection.at(d.model.collection.indexOf(g)-
1),_.isUndefined(d.current)||(f.model=d.current,f.render(),this.setNavButtonsState(),c(".previous-theme").focus()))}),this.listenTo(f,"preview:close",function(){d.current=d.model}))},setNavButtonsState:function(){var a=c(".theme-install-overlay"),d=_.isUndefined(this.current)?this.model:this.current;0===this.model.collection.indexOf(d)&&a.find(".previous-theme").addClass("disabled");_.isUndefined(this.model.collection.at(this.model.collection.indexOf(d)+1))&&a.find(".next-theme").addClass("disabled")}});
b.view.Details=wp.Backbone.View.extend({className:"theme-overlay",events:{click:"collapse","click .delete-theme":"deleteTheme","click .left":"previousTheme","click .right":"nextTheme"},html:b.template("theme-single"),render:function(){var a=this.model.toJSON();this.$el.html(this.html(a));this.activeTheme();this.navigation();this.screenshotCheck(this.$el);this.containFocus(this.$el)},activeTheme:function(){this.$el.toggleClass("active",this.model.get("active"))},containFocus:function(a){var d;_.delay(function(){c(".theme-wrap a.button-primary:visible").focus()},
500);a.on("keydown.wp-themes",function(b){9===b.which&&(d=c(b.target),d.is("button.left")&&b.shiftKey?(a.find(".theme-actions a:last-child").focus(),b.preventDefault()):d.is(".theme-actions a:last-child")&&(a.find("button.left").focus(),b.preventDefault()))})},collapse:function(a){var d=this,g;a=a||window.event;1!==b.data.themes.length&&(c(a.target).is(".theme-backdrop")||c(a.target).is(".close")||27===a.keyCode)&&(c("body").addClass("closing-overlay"),this.$el.fadeOut(130,function(){c("body").removeClass("closing-overlay");
d.closeOverlay();g=document.body.scrollTop;b.router.navigate(b.router.baseUrl(""));document.body.scrollTop=g;b.focusedTheme&&b.focusedTheme.focus()}))},navigation:function(){this.model.cid===this.model.collection.at(0).cid&&this.$el.find(".left").addClass("disabled");this.model.cid===this.model.collection.at(this.model.collection.length-1).cid&&this.$el.find(".right").addClass("disabled")},closeOverlay:function(){c("body").removeClass("modal-open");this.remove();this.unbind();this.trigger("theme:collapse")},
deleteTheme:function(){return confirm(b.data.settings.confirmDelete)},nextTheme:function(){this.trigger("theme:next",this.model.cid);return!1},previousTheme:function(){this.trigger("theme:previous",this.model.cid);return!1},screenshotCheck:function(a){var b,c;b=a.find(".screenshot img");c=new Image;c.src=b.attr("src");c.width&&300>=c.width&&a.addClass("small-screenshot")}});b.view.Preview=b.view.Details.extend({className:"wp-full-overlay expanded",el:".theme-install-overlay",events:{"click .close-full-overlay":"close",
"click .collapse-sidebar":"collapse","click .previous-theme":"previousTheme","click .next-theme":"nextTheme",keyup:"keyEvent"},html:b.template("theme-preview"),render:function(){var a=this.model.toJSON();this.$el.html(this.html(a));b.router.navigate(b.router.baseUrl(b.router.themePath+this.model.get("id")),{replace:!0});this.$el.fadeIn(200,function(){c("body").addClass("theme-installer-active full-overlay-active");c(".close-full-overlay").focus()})},close:function(){this.$el.fadeOut(200,function(){c("body").removeClass("theme-installer-active full-overlay-active");
b.focusedTheme&&b.focusedTheme.focus()});b.router.navigate(b.router.baseUrl(""));this.trigger("preview:close");this.undelegateEvents();this.unbind();return!1},collapse:function(a){a=c(a.currentTarget);"true"===a.attr("aria-expanded")?a.attr({"aria-expanded":"false","aria-label":e.expandSidebar}):a.attr({"aria-expanded":"true","aria-label":e.collapseSidebar});this.$el.toggleClass("collapsed").toggleClass("expanded");return!1},keyEvent:function(a){27===a.keyCode&&(this.undelegateEvents(),this.close());
if(39===a.keyCode)_.once(this.nextTheme());37===a.keyCode&&this.previousTheme()}});b.view.Themes=wp.Backbone.View.extend({className:"themes",$overlay:c("div.theme-overlay"),index:0,count:c(".wp-core-ui .theme-count"),liveThemeCount:0,initialize:function(a){var b=this;this.parent=a.parent;this.setView("grid");b.currentTheme();this.listenTo(b.collection,"update",function(){b.parent.page=0;b.currentTheme();b.render(this)});this.listenTo(b.collection,"query:success",function(a){_.isNumber(a)?(b.count.text(a),
b.announceSearchResults(a)):(b.count.text(b.collection.length),b.announceSearchResults(b.collection.length))});this.listenTo(b.collection,"query:empty",function(){c("body").addClass("no-results")});this.listenTo(this.parent,"theme:scroll",function(){b.renderThemes(b.parent.page)});this.listenTo(this.parent,"theme:close",function(){b.overlay&&b.overlay.closeOverlay()});c("body").on("keyup",function(a){b.overlay&&(39===a.keyCode&&b.overlay.nextTheme(),37===a.keyCode&&b.overlay.previousTheme(),27===
a.keyCode&&b.overlay.collapse(a))})},render:function(){this.$el.empty();1===b.data.themes.length&&(this.singleTheme=new b.view.Details({model:this.collection.models[0]}),this.singleTheme.render(),this.$el.addClass("single-theme"),this.$el.append(this.singleTheme.el));0<this.options.collection.size()&&this.renderThemes(this.parent.page);this.liveThemeCount=this.collection.count?this.collection.count:this.collection.length;this.count.text(this.liveThemeCount);this.announceSearchResults(this.liveThemeCount)},
renderThemes:function(a){var d=this;d.instance=d.collection.paginate(a);0===d.instance.size()?this.parent.trigger("theme:end"):(1<=a&&c(".add-new-theme").remove(),d.instance.each(function(a){d.theme=new b.view.Theme({model:a,parent:d});d.theme.render();d.$el.append(d.theme.el);d.listenTo(d.theme,"theme:expand",d.expand,d)}),b.data.settings.canInstall&&this.$el.append('<div class="theme add-new-theme"><a href="'+b.data.settings.installURI+'"><div class="theme-screenshot"><span></span></div><h3 class="theme-name">'+
e.addNew+"</h3></a></div>"),this.parent.page++)},currentTheme:function(){var a;if(a=this.collection.findWhere({active:!0}))this.collection.remove(a),this.collection.add(a,{at:0})},setView:function(a){return a},expand:function(a){var d=this;this.model=d.collection.get(a);b.router.navigate(b.router.baseUrl(b.router.themePath+this.model.id));this.setView("detail");c("body").addClass("modal-open");this.overlay=new b.view.Details({model:d.model});this.overlay.render();this.$overlay.html(this.overlay.el);
this.listenTo(this.overlay,"theme:next",function(){d.next([d.model.cid])}).listenTo(this.overlay,"theme:previous",function(){d.previous([d.model.cid])})},next:function(a){a=this.collection.get(a[0]);a=this.collection.at(this.collection.indexOf(a)+1);void 0!==a&&(this.overlay.closeOverlay(),this.theme.trigger("theme:expand",a.cid))},previous:function(a){a=this.collection.get(a[0]);a=this.collection.at(this.collection.indexOf(a)-1);void 0!==a&&(this.overlay.closeOverlay(),this.theme.trigger("theme:expand",
a.cid))},announceSearchResults:function(a){0===a?wp.a11y.speak(e.noThemesFound):wp.a11y.speak(e.themesFound.replace("%d",a))}});b.view.Search=wp.Backbone.View.extend({tagName:"input",className:"wp-filter-search",id:"wp-filter-search-input",searching:!1,attributes:{placeholder:e.searchPlaceholder,type:"search","aria-describedby":"live-search-desc"},events:{input:"search",keyup:"search",blur:"pushState"},initialize:function(a){this.parent=a.parent;this.listenTo(this.parent,"theme:close",function(){this.searching=
!1})},search:function(a){"keyup"===a.type&&27===a.which&&(a.target.value="");this.doSearch(a)},doSearch:_.debounce(function(a){var d={};this.collection.doSearch(a.target.value);this.searching&&13!==a.which?d.replace=!0:this.searching=!0;a.target.value?b.router.navigate(b.router.baseUrl(b.router.searchPath+a.target.value),d):b.router.navigate(b.router.baseUrl(""))},500),pushState:function(a){var d=b.router.baseUrl("");a.target.value&&(d=b.router.baseUrl(b.router.searchPath+a.target.value));this.searching=
!1;b.router.navigate(d)}});b.Router=Backbone.Router.extend({routes:{"themes.php?theme=:slug":"theme","themes.php?search=:query":"search","themes.php?s=:query":"search","themes.php":"themes","":"themes"},baseUrl:function(a){return"themes.php"+a},themePath:"?theme=",searchPath:"?search=",search:function(a){c(".wp-filter-search").val(a)},themes:function(){c(".wp-filter-search").val("")},navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}});b.Run=
{init:function(){this.themes=new b.Collection(b.data.themes);this.view=new b.view.Appearance({collection:this.themes});this.render()},render:function(){this.view.render();this.routes();Backbone.history.start({root:b.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var a=this;b.router=new b.Router;b.router.on("route:theme",function(b){a.view.view.expand(b)});b.router.on("route:themes",function(){a.themes.doSearch("");a.view.trigger("theme:close")});b.router.on("route:search",
function(){c(".wp-filter-search").trigger("keyup")});this.extraRoutes()},extraRoutes:function(){return!1}};b.view.InstallerSearch=b.view.Search.extend({events:{input:"search",keyup:"search"},search:function(a){if("keyup"!==a.type||9!==a.which&&16!==a.which)this.collection=this.options.parent.view.collection,"keyup"===a.type&&27===a.which&&(a.target.value=""),this.doSearch(a.target.value)},doSearch:_.debounce(function(a){var d={};d.search=a;"author:"===a.substring(0,7)&&(d.search="",d.author=a.slice(7));
"tag:"===a.substring(0,4)&&(d.search="",d.tag=[a.slice(4)]);c(".filter-links li > a.current").removeClass("current");c("body").removeClass("show-filters filters-applied");this.collection.query(d);b.router.navigate(b.router.baseUrl(b.router.searchPath+a),{replace:!0})},500)});b.view.Installer=b.view.Appearance.extend({el:"#wpbody-content .wrap",events:{"click .filter-links li > a":"onSort","click .theme-filter":"onFilter","click .drawer-toggle":"moreFilters","click .filter-drawer .apply-filters":"applyFilters",
'click .filter-group [type="checkbox"]':"addFilter","click .filter-drawer .clear-filters":"clearFilters","click .filtered-by":"backToFilters"},render:function(){var a=this;this.search();this.uploader();this.collection=new b.Collection;this.listenTo(this,"theme:end",function(){a.collection.loadingThemes||(a.collection.loadingThemes=!0,a.collection.currentQuery.page++,_.extend(a.collection.currentQuery.request,{page:a.collection.currentQuery.page}),a.collection.query(a.collection.currentQuery.request))});
this.listenTo(this.collection,"query:success",function(){c("body").removeClass("loading-content");c(".theme-browser").find("div.error").remove()});this.listenTo(this.collection,"query:fail",function(){c("body").removeClass("loading-content");c(".theme-browser").find("div.error").remove();c(".theme-browser").find("div.themes").before('<div class="error"><p>'+e.error+"</p></div>")});this.view&&this.view.remove();this.view=new b.view.Themes({collection:this.collection,parent:this});this.page=0;this.$el.find(".themes").remove();
this.view.render();this.$el.find(".theme-browser").append(this.view.el).addClass("rendered")},browse:function(a){this.collection.query({browse:a})},onSort:function(a){var d=c(a.target),g=d.data("sort");a.preventDefault();c("body").removeClass("filters-applied show-filters");d.hasClass(this.activeClass)||(this.sort(g),b.router.navigate(b.router.baseUrl(b.router.browsePath+g)))},sort:function(a){this.clearSearch();c(".filter-links li > a, .theme-filter").removeClass(this.activeClass);c('[data-sort="'+
a+'"]').addClass(this.activeClass);this.browse(a)},onFilter:function(a){a=c(a.target);var b=a.data("filter");a.hasClass(this.activeClass)||(c(".filter-links li > a, .theme-section").removeClass(this.activeClass),a.addClass(this.activeClass),b&&(b=_.union(b,this.filtersChecked()),a={tag:[b]},this.collection.query(a)))},addFilter:function(){this.filtersChecked()},applyFilters:function(a){var b,g=this.filtersChecked(),f={tag:g},e=c(".filtered-by .tags");a&&a.preventDefault();c("body").addClass("filters-applied");
c(".filter-links li > a.current").removeClass("current");e.empty();_.each(g,function(a){b=c('label[for="filter-id-'+a+'"]').text();e.append('<span class="tag">'+b+"</span>")});this.collection.query(f)},filtersChecked:function(){var a=c(".filter-group").find(":checkbox"),b=[];_.each(a.filter(":checked"),function(a){b.push(c(a).prop("value"))});if(0===b.length)return c(".filter-drawer .apply-filters").find("span").text(""),c(".filter-drawer .clear-filters").hide(),c("body").removeClass("filters-applied"),
!1;c(".filter-drawer .apply-filters").find("span").text(b.length);c(".filter-drawer .clear-filters").css("display","inline-block");return b},activeClass:"current",searchContainer:c(".wp-filter .search-form"),uploader:function(){c("a.upload").on("click",function(a){a.preventDefault();c("body").addClass("show-upload-theme");b.router.navigate(b.router.baseUrl("?upload"),{replace:!0})});c("a.browse-themes").on("click",function(a){a.preventDefault();c("body").removeClass("show-upload-theme");b.router.navigate(b.router.baseUrl(""),
{replace:!0})})},moreFilters:function(a){a.preventDefault();if(c("body").hasClass("filters-applied"))return this.backToFilters();if(c("body").hasClass("show-filters")&&this.filtersChecked())return this.addFilter();this.clearSearch();b.router.navigate(b.router.baseUrl(""));c("body").toggleClass("show-filters")},clearFilters:function(a){var b=c(".filter-group").find(":checkbox"),e=this;a.preventDefault();_.each(b.filter(":checked"),function(a){c(a).prop("checked",!1);return e.filtersChecked()})},backToFilters:function(a){a&&
a.preventDefault();c("body").removeClass("filters-applied")},clearSearch:function(){c("#wp-filter-search-input").val("")}});b.InstallerRouter=Backbone.Router.extend({routes:{"theme-install.php?theme=:slug":"preview","theme-install.php?browse=:sort":"sort","theme-install.php?upload":"upload","theme-install.php?search=:query":"search","theme-install.php":"sort"},baseUrl:function(a){return"theme-install.php"+a},themePath:"?theme=",browsePath:"?browse=",searchPath:"?search=",search:function(a){c(".wp-filter-search").val(a)},
navigate:function(){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.apply(this,arguments)}});b.RunInstaller={init:function(){this.view=new b.view.Installer({section:"featured",SearchView:b.view.InstallerSearch});this.render()},render:function(){this.view.render();this.routes();Backbone.history.start({root:b.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var a=this,d={};b.router=new b.InstallerRouter;b.router.on("route:preview",function(b){d.theme=b;a.view.collection.query(d)});
b.router.on("route:sort",function(b){b||(b="featured");a.view.sort(b);a.view.trigger("theme:close")});b.router.on("route:upload",function(){c("a.upload").trigger("click")});b.router.on("route:search",function(){c(".wp-filter-search").focus().trigger("keyup")});this.extraRoutes()},extraRoutes:function(){return!1}};c(document).ready(function(){b.isInstall?b.RunInstaller.init():b.Run.init();c(".broken-themes .delete-theme").on("click",function(){return confirm(_wpThemeSettings.settings.confirmDelete)})})})(jQuery);
var tb_position;jQuery(document).ready(function(c){tb_position=function(){var b=c("#TB_window"),e=c(window).width(),a=c(window).height(),e=1040<e?1040:e,d=0;c("#wpadminbar").length&&(d=parseInt(c("#wpadminbar").css("height"),10));b.size()&&(b.width(e-50).height(a-45-d),c("#TB_iframeContent").width(e-50).height(a-75-d),b.css({"margin-left":"-"+parseInt((e-50)/2,10)+"px"}),"undefined"!==typeof document.body.style.maxWidth&&b.css({top:20+d+"px","margin-top":"0"}))};c(window).resize(function(){tb_position()})});
