(function(h,p){h.PluginManager.add("wptextpattern",function(b){function q(a){if(a=b.dom.getParent(a,"p")){for(;(a=a.firstChild)&&3!==a.nodeType;);if(a)return a.data||(a=a.nextSibling&&3===a.nextSibling.nodeType?a.nextSibling:null),a}}function r(){var a=b.selection.getRng(),c=a.startContainer,f,d;c&&q(c)===c&&(f=c.parentNode,d=c.data,h.each(t,function(g){var e=d.match(g.regExp);if(e&&a.startOffset===e[0].length)return b.undoManager.add(),b.undoManager.transact(function(){c.deleteData(0,e[0].length);
f.innerHTML||f.appendChild(document.createElement("br"));b.selection.setCursorLocation(f);b.execCommand(g.cmd)}),p(function(){k="space"}),!1}))}function u(){d&&(b.undoManager.add(),b.undoManager.transact(function(){b.formatter.apply(l.format,{},d);d.replaceData(0,d.data.length,h.trim(d.data.slice(l.start.length)))}),p(function(){k="enter"}));l=d=null}var e=h.util.VK,t=[{regExp:/^[*-]\s/,cmd:"InsertUnorderedList"},{regExp:/^1[.)]\s/,cmd:"InsertOrderedList"}],n=[{start:"##",format:"h2"},{start:"###",
format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:">",format:"blockquote"}],k,d,l;b.on("selectionchange",function(){k=null});b.on("keydown",function(a){if(k&&27===a.keyCode||"space"===k&&a.keyCode===e.BACKSPACE)b.undoManager.undo(),a.preventDefault(),a.stopImmediatePropagation();if(a.keyCode===e.ENTER&&!e.modifierPressed(a)){a=b.selection.getRng().startContainer;var c=q(a),f=n.length,m,g;if(c){for(m=c.data;f--;)if(0===m.indexOf(n[f].start)){g=
n[f];break}!g||c===a&&h.trim(m)===g.start||(d=c,l=g)}}},!0);b.on("keyup",function(a){a.keyCode!==e.SPACEBAR||a.ctrlKey||a.metaKey||a.altKey?a.keyCode!==e.ENTER||e.modifierPressed(a)||u():r()})})})(window.tinymce,window.setTimeout);
