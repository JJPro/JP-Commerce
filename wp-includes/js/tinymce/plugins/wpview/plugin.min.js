tinymce.PluginManager.add("wpview",function(b){function l(a){return F(a,"wpview-wrap")}function F(a,c){for(;a&&a.parentNode;){if(a.className&&-1!==(" "+a.className+" ").indexOf(" "+c+" "))return a;a=a.parentNode}return!1}function z(a){a.stopPropagation()}function h(a,c){var e=a?"before":"after",f=a?0:1;m();b.selection.setCursorLocation(b.dom.select(".wpview-selection-"+e,c)[0],f);b.nodeChanged()}function v(a,c,r){var f=b.dom,g=f.create("p");G.ie&&11>G.ie||(g.innerHTML='<br data-mce-bogus="1">');c?
a.parentNode.insertBefore(g,a):f.insertAfter(g,a);m();c&&r===e.ENTER?h(c,a):b.selection.setCursorLocation(g,0);b.nodeChanged()}function u(a){b.undoManager.transact(function(){v(a);wp.mce.views.remove(b,a)})}function A(a){var c,e=b.dom;a&&(a!==k&&(b.getBody().focus(),m(),k=a,e.setAttrib(a,"data-mce-selected",1),c=e.create("div",{"class":"wpview-clipboard",contenteditable:"true"},wp.mce.views.getText(a)),b.dom.select(".wpview-body",a)[0].appendChild(c),e.bind(c,"beforedeactivate focusin focusout",z),
e.bind(k,"beforedeactivate focusin focusout",z),M?b.selection.select(c):b.selection.select(c,!0)),b.nodeChanged(),b.fire("wpview-selected",a))}function m(){var a,c=b.dom;k&&(a=b.dom.select(".wpview-clipboard",k)[0],c.unbind(a),c.remove(a),c.unbind(k,"beforedeactivate focusin focusout click mouseup",z),c.setAttrib(k,"data-mce-selected",null));k=null}function w(a,c){return"<p>"+window.decodeURIComponent(c)+"</p>"}function H(a){I("div[data-wpview-text], p[data-wpview-marker]",a).each(function(a,b){b.innerHTML=
"."})}function J(a){return 47>=a&&a!==e.SPACEBAR&&a!==e.ENTER&&a!==e.DELETE&&a!==e.BACKSPACE&&(37>a||40<a)||224<=a||144<=a&&150>=a||91<=a&&93>=a||112<=a&&135>=a}var I=b.$,k,G=tinymce.Env,e=tinymce.util.VK,N=tinymce.dom.TreeWalker,x=!1,B=!0,O=function(){return!1},M=/iPad|iPod|iPhone/.test(navigator.userAgent),K,C,D,E,p,y,L;if("undefined"===typeof wp||!wp.mce)return{getView:O};b.on("BeforeAddUndo",function(a){a.level.content&&(a.level.content=a.level.content.replace(/<div[^>]+data-wpview-text="([^"]+)"[^>]*>(?:[\s\S]+?wpview-selection-after[^>]+>[^<>]*<\/p>\s*|\.)<\/div>/g,
w).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,w))});b.on("BeforeSetContent",function(a){var c;a.selection||wp.mce.views.unbind();if(a.content){if(!a.load&&(k&&u(k),(c=b.selection.getNode())&&c!==b.getBody()&&/^\s*https?:\/\/\S+\s*$/i.test(a.content)))if((c=b.dom.getParent(c,"p"))&&/^[\s\uFEFF\u00A0]*$/.test(I(c).text()||""))c.innerHTML="";else return;a.content=wp.mce.views.setMarkers(a.content)}});b.on("pastePreProcess",function(a){var c=a.content;c&&(c=tinymce.trim(c.replace(/<[^>]+>/g,
"")),/^https?:\/\/\S+$/i.test(c)&&(a.content=c))});b.on("SetContent",function(){wp.mce.views.render()});b.on("click",function(a){var c=a.clientX,e=a.clientY,f=b.getBody(),g=f.getBoundingClientRect(),d=f.firstChild,f=f.lastChild,k,m,n;d&&f&&(k=d.getBoundingClientRect(),m=f.getBoundingClientRect(),e<k.top&&(n=l(d))?(h(!0,n),a.preventDefault()):e>m.bottom&&(n=l(f))?(h(!1,n),a.preventDefault()):(c<g.left||c>g.right)&&tinymce.each(b.dom.select(".wpview-wrap"),function(b){var d=b.getBoundingClientRect();
if(e<d.top)return!1;if(e>=d.top&&e<=d.bottom)return c<g.left?(h(!0,b),a.preventDefault()):c>g.right&&(h(!1,b),a.preventDefault()),!1}))});b.on("init",function(){var a=!1,c=b.selection,e=window.MutationObserver||window.WebKitMutationObserver;b.on("BeforeSetContent",function(){var a,e=l(c.getNode());e&&(!e.nextSibling||l(e.nextSibling)?(a=b.getDoc().createTextNode(""),b.dom.insertAfter(a,e)):(a=new N(e.nextSibling,e.nextSibling),a=a.next()),c.select(a),c.collapse(!0))});b.dom.bind(b.getDoc(),"touchmove",
function(){a=!0});b.on("mousedown mouseup click touchend",function(b){var c=l(b.target);B=!1;if(c)return b.stopImmediatePropagation(),b.preventDefault(),"touchend"===b.type&&a?a=!1:A(c),!1;"touchend"!==b.type&&"mousedown"!==b.type||m();"touchend"===b.type&&a&&(a=!1)},!0);e&&(new e(function(){b.fire("wp-body-class-change")})).observe(b.getBody(),{attributes:!0,attributeFilter:["class"]})});b.on("PreProcess",function(a){H(a.node)},!0);b.on("hide",function(){wp.mce.views.unbind();m();H()});b.on("PostProcess",
function(a){a.content&&(a.content=a.content.replace(/<div [^>]*?data-wpview-text="([^"]+)"[^>]*>[\s\S]*?<\/div>/g,w).replace(/<p [^>]*?data-wpview-marker="([^"]+)"[^>]*>[\s\S]*?<\/p>/g,w))});b.on("keydown",function(a){var c=a.keyCode,r=b.dom,f=b.selection,g,d,t,q,n,p;if(k)(a.metaKey||a.ctrlKey)&&c!==e.BACKSPACE&&86!==c||112<=c&&123>=c?(a.metaKey||a.ctrlKey)&&88===c&&(x=k):(d=l(f.getNode()),d!==k?m():c===e.LEFT?(h(!0,d),a.preventDefault()):c===e.UP?(d.previousSibling?l(d.previousSibling)?h(!0,d.previousSibling):
(m(),f.select(d.previousSibling,!0),f.collapse()):h(!0,d),a.preventDefault()):c===e.RIGHT?(h(!1,d),a.preventDefault()):c===e.DOWN?(d.nextSibling?l(d.nextSibling)?h(!1,d.nextSibling):(m(),f.setCursorLocation(d.nextSibling,0)):h(!1,d),a.preventDefault()):J(c)||(u(k),c!==e.ENTER&&c!==e.DELETE&&c!==e.BACKSPACE||a.preventDefault()));else if(!(a.metaKey||a.ctrlKey||112<=c&&123>=c)){C=g=f.getNode();d=l(g);if(!f.isCollapsed())if(q=f.getRng(),d=l(q.endContainer))n=q.cloneRange(),f.select(d.previousSibling,
!0),f.collapse(),p=f.getRng(),n.setEnd(p.endContainer,p.endOffset),f.setRng(n);else if(d=l(q.startContainer))n=q.cloneRange(),n.setStart(d.nextSibling,0),f.setRng(n);if(d)!(g=r.hasClass(d,"wpview-selection-before"))&&!(t=r.hasClass(d,"wpview-selection-after"))||J(c)||(t&&c===e.UP||g&&c===e.BACKSPACE?(d.previousSibling?l(d.previousSibling)?h(!1,d.previousSibling):r.isEmpty(d.previousSibling)&&c===e.BACKSPACE?r.remove(d.previousSibling):(f.select(d.previousSibling,!0),f.collapse()):h(!0,d),a.preventDefault()):
!t||c!==e.DOWN&&c!==e.RIGHT?!g||c!==e.UP&&c!==e.LEFT?g&&c===e.DOWN?(d.nextSibling?l(d.nextSibling)?h(!0,d.nextSibling):f.setCursorLocation(d.nextSibling,0):h(!1,d),a.preventDefault()):t&&c===e.LEFT||g&&c===e.RIGHT?(A(d),a.preventDefault()):t&&c===e.BACKSPACE?(u(d),a.preventDefault()):t?v(d):g&&v(d,!0,c):(d.previousSibling&&(l(d.previousSibling)?h(c===e.UP,d.previousSibling):(f.select(d.previousSibling,!0),f.collapse())),a.preventDefault()):(d.nextSibling&&(l(d.nextSibling)?h(c===e.RIGHT,d.nextSibling):
f.setCursorLocation(d.nextSibling,0)),a.preventDefault()),c===e.ENTER&&a.preventDefault());else if(a.keyCode===e.BACKSPACE)if(b.dom.isEmpty(g)){if(d=l(g.previousSibling))h(!1,d),b.dom.remove(g),a.preventDefault()}else(q=f.getRng())&&0===q.startOffset&&0===q.endOffset&&(d=l(g.previousSibling))&&(h(!1,d),a.preventDefault())}});b.on("keyup",function(){x&&(u(x),x=!1)});b.on("focus",function(){var a;E=!0;b.dom.addClass(b.getBody(),"has-focus");B&&(a=l(b.getBody().firstChild))&&h(!0,a);B=!1});b.on("blur",
function(){E=!1;b.dom.removeClass(b.getBody(),"has-focus")});b.on("NodeChange",function(a){var c=b.dom,e=b.dom.select(".wpview-wrap"),f=a.element.className,g=l(a.element),d=C;C=!1;clearInterval(K);tinymce.each(e,function(a){a.className&&(a.className=a.className.replace(/ ?\bwpview-(?:selection-before|selection-after|cursor-hide)\b/g,""))});E&&g&&("wpview-selection-before"!==f&&"wpview-selection-after"!==f||!b.selection.isCollapsed()?F(a.element,"wpview-clipboard")||D||(m(),D++,h(!0,g)):(D=0,m(),d===
g.previousSibling?h(!0,g):d===g.nextSibling?h(!1,g):(c.addClass(g,f),K=setInterval(function(){c.hasClass(g,"wpview-cursor-hide")?c.removeClass(g,"wpview-cursor-hide"):c.addClass(g,"wpview-cursor-hide")},500))))});b.on("BeforeExecCommand",function(){var a=b.selection.getNode(),c;a&&((y="wpview-selection-before"===a.className)||"wpview-selection-after"===a.className)&&(c=l(a))&&(v(c,y),p=c)});b.on("ExecCommand",function(){var a;k&&(a=k,m(),A(a));p&&((a=p[y?"previousSibling":"nextSibling"])&&"P"===a.nodeName&&
b.dom.isEmpty(a)&&(b.dom.remove(a),h(y,p)),p=!1)});b.on("ResolveName",function(a){b.dom.hasClass(a.target,"wpview-wrap")?(a.name=b.dom.getAttrib(a.target,"data-wpview-type")||"wpview",a.stopPropagation()):l(a.target)&&(a.preventDefault(),a.stopPropagation())});b.addButton("wp_view_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){k&&wp.mce.views.edit(b,k)}});b.addButton("wp_view_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){k&&u(k)}});b.once("preinit",
function(){b.wp&&b.wp._createToolbar&&(L=b.wp._createToolbar(["wp_view_edit","wp_view_remove"]))});b.on("wptoolbar",function(a){k&&(a.element=k,a.toolbar=L)});b.wp=b.wp||{};b.wp.getView=l;b.wp.setViewCursor=h;return{getView:l}});
