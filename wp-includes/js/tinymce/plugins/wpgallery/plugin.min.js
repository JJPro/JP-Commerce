tinymce.PluginManager.add("wpgallery",function(d){function g(a){return a.replace(/\[gallery([^\]]*)\]/g,function(a){a=window.encodeURIComponent(a);return'<img src="'+tinymce.Env.transparentSrc+'" class="wp-media mceItem wp-gallery" data-wp-media="'+a+'" data-mce-resize="false" data-mce-placeholder="1" alt="" />'})}function h(a){return a.replace(/(?:<p(?: [^>]+)?>)*(<img [^>]+>)(?:<\/p>)*/g,function(a,c){var b;return(b=(b=(new RegExp('data-wp-media="([^"]+)"')).exec(c))?window.decodeURIComponent(b[1]):
"")?"<p>"+b+"</p>":a})}function f(a){var e,c,b;"IMG"===a.nodeName&&"undefined"!==typeof wp&&wp.media&&(b=window.decodeURIComponent(d.dom.getAttrib(a,"data-wp-media")),d.dom.hasClass(a,"wp-gallery")&&wp.media.gallery&&(e=wp.media.gallery,c=e.edit(b),c.state("gallery-edit").on("update",function(b){b=e.shortcode(b).string();d.dom.setAttrib(a,"data-wp-media",window.encodeURIComponent(b));c.detach()})))}d.addCommand("WP_Gallery",function(){f(d.selection.getNode())});d.on("mouseup",function(a){function e(){c.removeClass(c.select("img.wp-media-selected"),
"wp-media-selected")}var c=d.dom,b=a.target;"IMG"===b.nodeName&&c.getAttrib(b,"data-wp-media")?2!==a.button&&(c.hasClass(b,"wp-media-selected")?f(b):(e(),c.addClass(b,"wp-media-selected"))):e()});d.on("ResolveName",function(a){var e=d.dom,c=a.target;"IMG"===c.nodeName&&e.getAttrib(c,"data-wp-media")&&e.hasClass(c,"wp-gallery")&&(a.name="gallery")});d.on("BeforeSetContent",function(a){d.plugins.wpview&&"undefined"!==typeof wp&&wp.mce||(a.content=g(a.content))});d.on("PostProcess",function(a){a.get&&
(a.content=h(a.content))})});
