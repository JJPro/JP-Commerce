tinymce.PluginManager.add("wpeditimage",function(b){function t(a){return!(!b.dom.getAttrib(a,"data-mce-placeholder")&&!b.dom.getAttrib(a,"data-mce-object"))}function u(a){return a.replace(/(?:<p>)?\[(?:wp_)?caption([^\]]+)\]([\s\S]+?)\[\/(?:wp_)?caption\](?:<\/p>)?/g,function(a,f,d){var e,n,h,g;(a=f.match(/id=['"]([^'"]*)['"] ?/))&&(f=f.replace(a[0],""));(e=f.match(/align=['"]([^'"]*)['"] ?/))&&(f=f.replace(e[0],""));(n=f.match(/class=['"]([^'"]*)['"] ?/))&&(f=f.replace(n[0],""));(g=f.match(/width=['"]([0-9]*)['"] ?/))&&
(f=f.replace(g[0],""));d=q(d);(h=d.match(/((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)([\s\S]*)/i))&&h[2]?(f=q(h[2]),h=q(h[1])):(f=q(f).replace(/caption=['"]/,"").replace(/['"]$/,""),h=d);a=a&&a[1]?a[1].replace(/[<>&]+/g,""):"";e=e&&e[1]?e[1]:"alignnone";n=n&&n[1]?" "+n[1].replace(/[<>&]+/g,""):"";!g&&h&&(g=h.match(/width=['"]([0-9]*)['"]/));g&&g[1]&&(g=g[1]);if(!g||!f)return d;g=parseInt(g,10);b.getParam("wpeditimage_html5_captions")||(g+=10);return'<div class="mceTemp"><dl id="'+a+'" class="wp-caption '+
e+n+'" style="width: '+g+'px"><dt class="wp-caption-dt">'+h+'</dt><dd class="wp-caption-dd">'+f+"</dd></dl></div>"})}function v(a){return a.replace(/<div (?:id="attachment_|class="mceTemp)[^>]*>([\s\S]+?)<\/div>/g,function(a,b){var d="";if(-1===b.indexOf("<img "))return(d=b.match(/<dd [^>]+>([\s\S]+?)<\/dd>/i))&&d[1]?"<p>"+d[1]+"</p>":"";d=b.replace(/\s*<dl ([^>]+)>\s*<dt [^>]+>([\s\S]+?)<\/dt>\s*<dd [^>]+>([\s\S]*?)<\/dd>\s*<\/dl>\s*/gi,function(a,d,b,f){var c,m;m=(m=b.match(/width="([0-9]*)"/))&&
m[1]?m[1]:"";a=(a=d.match(/class="([^"]*)"/))&&a[1]?a[1]:"";c=a.match(/align[a-z]+/i)||"alignnone";if(!m||!f)return"alignnone"!==c[0]&&(b=b.replace(/><img/,' class="'+c[0]+'"><img')),b;d=(d=d.match(/id="([^"]*)"/))&&d[1]?d[1]:"";(a=a.replace(/wp-caption ?|align[a-z]+ ?/gi,""))&&(a=' class="'+a+'"');f=f.replace(/\r\n|\r/g,"\n").replace(/<[a-zA-Z0-9]+( [^<>]+)?>/g,function(a){return a.replace(/[\r\n\t]+/," ")});f=f.replace(/\s*\n\s*/g,"<br />");return'[caption id="'+d+'" align="'+c+'" width="'+m+'"'+
a+"]"+b+" "+f+"[/caption]"});-1===d.indexOf("[caption")&&(d=b.replace(/[\s\S]*?((?:<a [^>]+>)?<img [^>]+>(?:<\/a>)?)(<p>[\s\S]*<\/p>)?[\s\S]*/gi,"<p>$1</p>$2"));return d})}function z(a){var c,f,d,e,n=[],h=b.dom,g=/^\d+$/;d={attachment_id:!1,size:"custom",caption:"",align:"none",extraClasses:"",link:!1,linkUrl:"",linkClassName:"",linkTargetBlank:!1,linkRel:"",title:""};d.url=h.getAttrib(a,"src");d.alt=h.getAttrib(a,"alt");d.title=h.getAttrib(a,"title");c=h.getAttrib(a,"width");e=h.getAttrib(a,"height");
if(!g.test(c)||1>parseInt(c,10))c=a.naturalWidth||a.width;if(!g.test(e)||1>parseInt(e,10))e=a.naturalHeight||a.height;d.customWidth=d.width=c;d.customHeight=d.height=e;c=tinymce.explode(a.className," ");f=[];tinymce.each(c,function(a){/^wp-image/.test(a)?d.attachment_id=parseInt(a.replace("wp-image-",""),10):/^align/.test(a)?d.align=a.replace("align",""):/^size/.test(a)?d.size=a.replace("size-",""):f.push(a)});d.extraClasses=f.join(" ");e=h.getParents(a,".wp-caption");e.length&&(e=e[0],c=e.className.split(" "),
tinymce.each(c,function(a){/^align/.test(a)?d.align=a.replace("align",""):a&&"wp-caption"!==a&&n.push(a)}),d.captionClassName=n.join(" "),c=h.select("dd.wp-caption-dd",e),c.length&&(c=c[0],d.caption=b.serializer.serialize(c).replace(/<br[^>]*>/g,"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")));a.parentNode&&"A"===a.parentNode.nodeName&&(a=a.parentNode,d.linkUrl=h.getAttrib(a,"href"),d.linkTargetBlank="_blank"===h.getAttrib(a,"target")?!0:!1,d.linkRel=h.getAttrib(a,"rel"),d.linkClassName=a.className);
return d}function w(a){return a&&!(!a.textContent&&!a.innerText)}function x(a){if(!a||-1===a.indexOf("<")&&-1===a.indexOf(">"))return a;r||(r=new tinymce.html.Serializer({},b.schema));return r.serialize(b.parser.parse(a,{forced_root_block:!1}))}function A(a){var c,f;"undefined"!==typeof wp&&wp.media?(f=z(a),wp.media.events.trigger("editor:image-edit",{editor:b,metadata:f,image:a}),c=wp.media({frame:"image",state:"image-details",metadata:f}),wp.media.events.trigger("editor:frame-create",{frame:c}),
f=function(d){b.focus();b.undoManager.transact(function(){var e,f,c,g,l,m,k=b.dom;(e=tinymce.explode(d.extraClasses," "))||(e=[]);d.caption||e.push("align"+d.align);d.attachment_id&&(e.push("wp-image-"+d.attachment_id),d.size&&"custom"!==d.size&&e.push("size-"+d.size));g=d.width;m=d.height;"custom"===d.size&&(g=d.customWidth,m=d.customHeight);e={src:d.url,width:g||null,height:m||null,alt:d.alt,title:d.title||null,"class":e.join(" ")||null};k.setAttribs(a,e);e={href:d.linkUrl,rel:d.linkRel||null,target:d.linkTargetBlank?
"_blank":null,"class":d.linkClassName||null};a.parentNode&&"A"===a.parentNode.nodeName&&!w(a.parentNode)?d.linkUrl?k.setAttribs(a.parentNode,e):k.remove(a.parentNode,!0):d.linkUrl&&((c=k.getParent(a,"a"))&&k.insertAfter(a,c),c=k.create("a",e),a.parentNode.insertBefore(c,a),c.appendChild(a));e=b.dom.getParent(a,".mceTemp");c=a.parentNode&&"A"===a.parentNode.nodeName&&!w(a.parentNode)?a.parentNode:a;d.caption?(d.caption=x(d.caption),m=d.attachment_id?"attachment_"+d.attachment_id:null,f="align"+(d.align||
"none"),f="wp-caption "+f,d.captionClassName&&(f+=" "+d.captionClassName.replace(/[<>&]+/g,"")),b.getParam("wpeditimage_html5_captions")||(g=parseInt(g,10),g+=10),e?(l=k.select("dl.wp-caption",e),l.length&&k.setAttribs(l,{id:m,"class":f,style:"width: "+g+"px"}),l=k.select(".wp-caption-dd",e),l.length&&k.setHTML(l[0],d.caption)):(g="<dl "+(m?'id="'+m+'" ':"")+'class="'+f+'" style="width: '+g+'px"><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+d.caption+"</dd></dl>",g=k.create("div",{"class":"mceTemp"},
g),(l=k.getParent(c,"p"))?l.parentNode.insertBefore(g,l):c.parentNode.insertBefore(g,c),b.$(g).find("dt.wp-caption-dt").append(c),l&&k.isEmpty(l)&&k.remove(l))):e&&(l=k.create("p"),e.parentNode.insertBefore(l,e),l.appendChild(c),k.remove(e));wp.media.events&&wp.media.events.trigger("editor:image-update",{editor:b,metadata:d,image:a});b.nodeChanged()});c.detach()},c.state("image-details").on("update",f),c.state("replace-image").on("replace",f),c.on("close",function(){b.focus();c.detach()}),c.open()):
b.execCommand("mceImage")}function y(a){var c=b.dom.getParent(a,"div.mceTemp");c||"IMG"!==a.nodeName||(c=b.dom.getParent(a,"a"));c?(c.nextSibling?b.selection.select(c.nextSibling):c.previousSibling?b.selection.select(c.previousSibling):b.selection.select(c.parentNode),b.selection.collapse(!0),b.dom.remove(c)):b.dom.remove(a);b.nodeChanged();b.undoManager.add()}var p,r,B=tinymce.each,q=tinymce.trim,C=tinymce.Env.iOS;b.addButton("wp_img_remove",{tooltip:"Remove",icon:"dashicon dashicons-no",onclick:function(){y(b.selection.getNode())}});
b.addButton("wp_img_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",onclick:function(){A(b.selection.getNode())}});B({alignleft:"Align left",aligncenter:"Align center",alignright:"Align right",alignnone:"No alignment"},function(a,c){var f=c.slice(5);b.addButton("wp_img_"+c,{tooltip:a,icon:"dashicon dashicons-align-"+f,cmd:"alignnone"===c?"wpAlignNone":"Justify"+f.slice(0,1).toUpperCase()+f.slice(1),onPostRender:function(){var a=this;b.on("NodeChange",function(e){"IMG"===e.element.nodeName&&
(e=b.dom.getParent(e.element,".wp-caption")||e.element,"alignnone"===c?a.active(!/\balign(left|center|right)\b/.test(e.className)):a.active(b.dom.hasClass(e,c)))})}})});b.once("preinit",function(){b.wp&&b.wp._createToolbar&&(p=b.wp._createToolbar("wp_img_alignleft wp_img_aligncenter wp_img_alignright wp_img_alignnone wp_img_edit wp_img_remove".split(" ")))});b.on("wptoolbar",function(a){"IMG"!==a.element.nodeName||t(a.element)||(a.toolbar=p)});if(C)b.on("click",function(a){if("IMG"===a.target.nodeName){var c=
a.target;window.setTimeout(function(){b.selection.select(c);b.nodeChanged()},200)}else p&&p.hide()});b.on("init",function(){var a=b.dom,c=b.getParam("wpeditimage_html5_captions")?"html5-captions":"html4-captions";a.addClass(b.getBody(),c);b.on("wpLoadImageForm",function(a){b.getParam("wpeditimage_disable_captions")||a.data.splice(a.data.length-1,0,{type:"textbox",flex:1,name:"caption",minHeight:60,multiline:!0,scroll:!0,label:"Image caption"})});b.on("wpNewImageRefresh",function(b){var d;(d=a.getParent(b.node,
"dl.wp-caption"))&&!d.style.width&&(b=parseInt(b.node.clientWidth,10)+10,a.setStyle(d,"width",b?b+"px":"50%"))});b.on("wpImageFormSubmit",function(c){var d=c.imgData.data,e=c.imgData.node,n=c.imgData.caption,h="",g="",l="",m,k,p;d.id="__wp-temp-img-id";c.imgData.cancel=!0;d.style||(d.style=null);if(d.src){n&&(n=n.replace(/\r\n|\r/g,"\n").replace(/<\/?[a-zA-Z0-9]+( [^<>]+)?>/g,function(a){return a.replace(/[\r\n\t]+/," ")}),n=n.replace(/(<br[^>]*>)\s*\n\s*/g,"$1").replace(/\s*\n\s*/g,"<br />"),n=x(n));
if(e)if(p=e.id||null,a.setAttribs(e,d),m=a.getParent(e,"dl.wp-caption"),n)if(m){if(k=a.select("dd.wp-caption-dd",m)[0])k.innerHTML=n}else{e.className&&(h=e.className.match(/wp-image-([0-9]+)/),g=e.className.match(/align(left|right|center|none)/));g?(g=g[0],e.className=e.className.replace(/align(left|right|center|none)/g,"")):g="alignnone";g=' class="wp-caption '+g+'"';h&&(h=' id="attachment_'+h[1]+'"');if(l=d.width||e.clientWidth)l=parseInt(l,10),b.getParam("wpeditimage_html5_captions")||(l+=10),
l=' style="width: '+l+'px"';e=e.parentNode&&"A"===e.parentNode.nodeName?e.parentNode:e;m=a.create("div",{"class":"mceTemp"},"<dl "+h+g+l+'><dt class="wp-caption-dt"></dt><dd class="wp-caption-dd">'+n+"</dd></dl>");(k=a.getParent(e,"p"))?k.parentNode.insertBefore(m,k):e.parentNode.insertBefore(m,e);b.$(m).find("dt.wp-caption-dt").append(e);k&&a.isEmpty(k)&&a.remove(k)}else m&&(h="A"===e.parentNode.nodeName?a.getOuterHTML(e.parentNode):a.getOuterHTML(e),k=a.create("p",{},h),a.insertAfter(k,m.parentNode),
b.selection.select(k),b.nodeChanged(),a.remove(m.parentNode));else h=a.createHTML("img",d),n?(e=b.selection.getNode(),d.width&&(l=parseInt(d.width,10),b.getParam("wpeditimage_html5_captions")||(l+=10),l=' style="width: '+l+'px"'),h='<dl class="wp-caption alignnone"'+l+'><dt class="wp-caption-dt">'+h+'</dt><dd class="wp-caption-dd">'+n+"</dd></dl>",(k="P"===e.nodeName?e:a.getParent(e,"p"))&&"P"===k.nodeName?(m=a.create("div",{"class":"mceTemp"},h),k.parentNode.insertBefore(m,k),b.selection.select(m),
b.nodeChanged(),a.isEmpty(k)&&a.remove(k)):b.selection.setContent('<div class="mceTemp">'+h+"</div>")):b.selection.setContent(h);e=a.get("__wp-temp-img-id");a.setAttrib(e,"id",p);c.imgData.node=e}else e&&((m=a.getParent(e,"div.mceTemp"))?a.remove(m):"A"===e.parentNode.nodeName?a.remove(e.parentNode):a.remove(e),b.nodeChanged())});b.on("wpLoadImageData",function(c){var d=c.imgData.data;if(c=a.getParent(c.imgData.node,"dl.wp-caption"))if(c=a.select("dd.wp-caption-dd",c)[0])d.caption=b.serializer.serialize(c).replace(/<br[^>]*>/g,
"$&\n").replace(/^<p>/,"").replace(/<\/p>$/,"")});a.bind(b.getDoc(),"dragstart",function(c){var d=b.selection.getNode();"IMG"===d.nodeName&&a.getParent(d,".wp-caption")&&c.preventDefault()});tinymce.Env.ie&&10<tinymce.Env.ie&&a.bind(b.getBody(),"mscontrolselect",function(c){"IMG"===c.target.nodeName&&a.getParent(c.target,".wp-caption")?b.getBody().focus():"DL"===c.target.nodeName&&a.hasClass(c.target,"wp-caption")&&c.target.focus()})});b.on("ObjectResized",function(a){var c=a.target;"IMG"===c.nodeName&&
b.undoManager.transact(function(){var f,d,e=b.dom;c.className=c.className.replace(/\bsize-[^ ]+/,"");if(f=e.getParent(c,".wp-caption"))if(d=a.width||e.getAttrib(c,"width"))d=parseInt(d,10),b.getParam("wpeditimage_html5_captions")||(d+=10),e.setStyle(f,"width",d+"px")})});b.on("BeforeExecCommand",function(a){var c,f,d,e=a.command;f=b.dom;if("mceInsertContent"===e){if(c=f.getParent(b.selection.getNode(),"div.mceTemp"))a=f.create("p"),f.insertAfter(a,c),b.selection.setCursorLocation(a,0),b.nodeChanged()}else if("JustifyLeft"===
e||"JustifyRight"===e||"JustifyCenter"===e||"wpAlignNone"===e)if(c=b.selection.getNode(),d="align"+e.slice(7).toLowerCase(),f=b.dom.getParent(c,".wp-caption"),"IMG"===c.nodeName||f)c=f||c,f=b.dom.hasClass(c,d)?" alignnone":" "+d,c.className=q(c.className.replace(/ ?align(left|center|right|none)/g,"")+f),b.nodeChanged(),a.preventDefault(),p&&p.reposition(),b.fire("ExecCommand",{command:e,ui:a.ui,value:a.value})});b.on("keydown",function(a){var c,f,d=b.selection;c=a.keyCode;var e=b.dom,n=tinymce.util.VK;
if(c===n.ENTER){if(c=d.getNode(),f=e.getParent(c,"div.mceTemp"))e.events.cancel(a),tinymce.each(e.select("dt, dd",f),function(a){e.isEmpty(a)&&e.remove(a)}),a=tinymce.Env.ie&&11>tinymce.Env.ie?"":'<br data-mce-bogus="1" />',a=e.create("p",null,a),"DD"===c.nodeName?e.insertAfter(a,f):f.parentNode.insertBefore(a,f),b.nodeChanged(),d.setCursorLocation(a,0)}else if(c===n.DELETE||c===n.BACKSPACE){c=d.getNode();if("DIV"===c.nodeName&&e.hasClass(c,"mceTemp"))f=c;else if("IMG"===c.nodeName||"DT"===c.nodeName||
"A"===c.nodeName)f=e.getParent(c,"div.mceTemp");if(f)return e.events.cancel(a),y(c),!1}});if(tinymce.Env.gecko)b.on("undo redo",function(){"IMG"===b.selection.getNode().nodeName&&b.selection.collapse()});b.wpSetImgCaption=function(a){return u(a)};b.wpGetImgCaption=function(a){return v(a)};b.on("BeforeSetContent",function(a){"raw"!==a.format&&(a.content=b.wpSetImgCaption(a.content))});b.on("PostProcess",function(a){a.get&&(a.content=b.wpGetImgCaption(a.content))});b.wp=b.wp||{};b.wp.isPlaceholder=
t;return{_do_shcode:u,_get_shcode:v}});
