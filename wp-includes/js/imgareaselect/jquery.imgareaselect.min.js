(function(b){function B(){return b("<div/>")}var C=Math.abs,l=Math.max,p=Math.min,g=Math.round;b.imgAreaSelect=function(z,d){function P(a){return a+A.left-N.left}function Q(a){return a+A.top-N.top}function J(a){return a-A.left+N.left}function K(a){return a-A.top+N.top}function V(a){return l(a.pageX||0,xa(a).x)-N.left}function W(a){return l(a.pageY||0,xa(a).y)-N.top}function xa(a){a=a.originalEvent||{};return a.touches&&a.touches.length?{x:a.touches[0].pageX,y:a.touches[0].pageY}:{x:0,y:0}}function G(a){var d=
a||X;a=a||Y;return{x1:g(c.x1*d),y1:g(c.y1*a),x2:g(c.x2*d),y2:g(c.y2*a),width:g(c.x2*d)-g(c.x1*d),height:g(c.y2*a)-g(c.y1*a)}}function la(a,d,b,f,e){var h=e||X;e=e||Y;c={x1:g(a/h||0),y1:g(d/e||0),x2:g(b/h||0),y2:g(f/e||0)};c.width=c.x2-c.x1;c.height=c.y2-c.y1}function O(){da&&x.width()&&(A={left:g(x.offset().left),top:g(x.offset().top)},y=x.innerWidth(),v=x.innerHeight(),A.top+=x.outerHeight()-v>>1,A.left+=x.outerWidth()-y>>1,Z=g(d.minWidth/X)||0,aa=g(d.minHeight/Y)||0,ma=g(p(d.maxWidth/X||16777216,
y)),na=g(p(d.maxHeight/Y||16777216,v)),"1.3.2"!=b().jquery||"fixed"!=ea||oa.getBoundingClientRect||(A.top+=l(document.body.scrollTop,oa.scrollTop),A.left+=l(document.body.scrollLeft,oa.scrollLeft)),N=/absolute|relative/.test(R.css("position"))?{left:g(R.offset().left)-R.scrollLeft(),top:g(R.offset().top)-R.scrollTop()}:"fixed"==ea?{left:b(document).scrollLeft(),top:b(document).scrollTop()}:{left:0,top:0},q=P(0),r=Q(0),(c.x2>y||c.y2>v)&&fa())}function ga(a){if(ha){m.css({left:P(c.x1),top:Q(c.y1)}).add(S).width(E=
c.width).height(L=c.height);S.add(u).add(t).css({left:0,top:0});u.width(l(E-u.outerWidth()+u.innerWidth(),0)).height(l(L-u.outerHeight()+u.innerHeight(),0));b(n[0]).css({left:q,top:r,width:c.x1,height:v});b(n[1]).css({left:q+c.x1,top:r,width:E,height:c.y1});b(n[2]).css({left:q+c.x2,top:r,width:y-c.x2,height:v});b(n[3]).css({left:q+c.x1,top:r+c.y2,width:E,height:v-c.y2});E-=t.outerWidth();L-=t.outerHeight();switch(t.length){case 8:b(t[4]).css({left:E>>1}),b(t[5]).css({left:E,top:L>>1}),b(t[6]).css({left:E>>
1,top:L}),b(t[7]).css({top:L>>1});case 4:t.slice(1,3).css({left:E}),t.slice(2,4).css({top:L})}if(!1!==a&&(b.imgAreaSelect.onKeyPress!=ya&&b(document).unbind(b.imgAreaSelect.keyPress,b.imgAreaSelect.onKeyPress),d.keys))b(document)[b.imgAreaSelect.keyPress](b.imgAreaSelect.onKeyPress=ya);T&&2==u.outerWidth()-u.innerWidth()&&(u.css("margin",0),setTimeout(function(){u.css("margin","auto")},0))}}function pa(a){O();ga(a);f=P(c.x1);e=Q(c.y1);h=P(c.x2);k=Q(c.y2)}function qa(a,b){d.fadeSpeed?a.fadeOut(d.fadeSpeed,
b):a.hide()}function M(a){var b=J(V(a))-c.x1;a=K(W(a))-c.y1;ra||(O(),ra=!0,m.one("mouseout",function(){ra=!1}));w="";d.resizable&&(a<=d.resizeMargin?w="n":a>=c.height-d.resizeMargin&&(w="s"),b<=d.resizeMargin?w+="w":b>=c.width-d.resizeMargin&&(w+="e"));m.css("cursor",w?w+"-resize":d.movable?"move":"");ia&&ia.toggle()}function za(a){b("body").css("cursor","");(d.autoHide||0==c.width*c.height)&&qa(m.add(n),function(){b(this).hide()});b(document).off("mousemove touchmove",sa);m.on("mousemove touchmove",
M);d.onSelectEnd(z,G())}function Aa(a){if("mousedown"==a.type&&1!=a.which)return!1;M(a);O();w?(b("body").css("cursor",w+"-resize"),f=P(c[/w/.test(w)?"x2":"x1"]),e=Q(c[/n/.test(w)?"y2":"y1"]),b(document).on("mousemove touchmove",sa).one("mouseup touchend",za),m.off("mousemove touchmove",M)):d.movable?(ta=q+c.x1-V(a),ua=r+c.y1-W(a),m.off("mousemove touchmove",M),b(document).on("mousemove touchmove",Ba).one("mouseup touchend",function(){d.onSelectEnd(z,G());b(document).off("mousemove touchmove",Ba);
m.on("mousemove touchmove",M)})):x.mousedown(a);return!1}function ba(a){H&&(a?(h=l(q,p(q+y,f+C(k-e)*H*(h>f||-1))),k=g(l(r,p(r+v,e+C(h-f)/H*(k>e||-1)))),h=g(h)):(k=l(r,p(r+v,e+C(h-f)/H*(k>e||-1))),h=g(l(q,p(q+y,f+C(k-e)*H*(h>f||-1)))),k=g(k)))}function fa(){f=p(f,q+y);e=p(e,r+v);C(h-f)<Z&&(h=f-Z*(h<f||-1),h<q?f=q+Z:h>q+y&&(f=q+y-Z));C(k-e)<aa&&(k=e-aa*(k<e||-1),k<r?e=r+aa:k>r+v&&(e=r+v-aa));h=l(q,p(h,q+y));k=l(r,p(k,r+v));ba(C(h-f)<C(k-e)*H);C(h-f)>ma&&(h=f-ma*(h<f||-1),ba());C(k-e)>na&&(k=e-na*(k<
e||-1),ba(!0));c={x1:J(p(f,h)),x2:J(l(f,h)),y1:K(p(e,k)),y2:K(l(e,k)),width:C(h-f),height:C(k-e)};ga();d.onSelectChange(z,G())}function sa(a){h=/w|e|^$/.test(w)||H?V(a):P(c.x2);k=/n|s|^$/.test(w)||H?W(a):Q(c.y2);fa();return!1}function ca(a,g){h=(f=a)+c.width;k=(e=g)+c.height;b.extend(c,{x1:J(f),y1:K(e),x2:J(h),y2:K(k)});ga();d.onSelectChange(z,G())}function Ba(a){f=l(q,p(ta+V(a),q+y-c.width));e=l(r,p(ua+W(a),r+v-c.height));ca(f,e);a.preventDefault();return!1}function va(){b(document).off("mousemove touchmove",
va);O();h=f;k=e;fa();w="";n.is(":visible")||m.add(n).hide().fadeIn(d.fadeSpeed||0);ha=!0;b(document).off("mouseup touchend",ja).on("mousemove touchmove",sa).one("mouseup touchend",za);m.off("mousemove touchmove",M);d.onSelectStart(z,G())}function ja(){b(document).off("mousemove touchmove",va).off("mouseup touchend",ja);qa(m.add(n));la(J(f),K(e),J(f),K(e));this instanceof b.imgAreaSelect||(d.onSelectChange(z,G()),d.onSelectEnd(z,G()))}function Ca(a){if(1!=a.which||n.is(":animated"))return!1;O();ta=
f=V(a);ua=e=W(a);b(document).on({"mousemove touchmove":va,"mouseup touchend":ja});return!1}function Da(){pa(!1)}function Ea(){da=!0;wa(d=b.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d));m.add(n).css({visibility:""});d.show&&(ha=!0,O(),ga(),m.add(n).hide().fadeIn(d.fadeSpeed||0));setTimeout(function(){d.onInit(z,G())},0)}function ka(a,b){for(var c in b)void 0!==
d[c]&&a.css(b[c],d[c])}function wa(a){a.parent&&(R=b(a.parent)).append(m.add(n));b.extend(d,a);O();if(null!=a.handles){t.remove();t=b([]);for(U=a.handles?"corners"==a.handles?4:8:0;U--;)t=t.add(B());t.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:I+1||1});0<=!parseInt(t.css("width"))&&t.width(5).height(5);(F=d.borderWidth)&&t.css({borderWidth:F,borderStyle:"solid"});ka(t,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}X=d.imageWidth/
y||1;Y=d.imageHeight/v||1;null!=a.x1&&(la(a.x1,a.y1,a.x2,a.y2),a.show=!a.hide);a.keys&&(d.keys=b.extend({shift:1,ctrl:"resize"},a.keys));n.addClass(d.classPrefix+"-outer");S.addClass(d.classPrefix+"-selection");for(U=0;4>U++;)b(u[U-1]).addClass(d.classPrefix+"-border"+U);ka(S,{selectionColor:"background-color",selectionOpacity:"opacity"});ka(u,{borderOpacity:"opacity",borderWidth:"border-width"});ka(n,{outerColor:"background-color",outerOpacity:"opacity"});(F=d.borderColor1)&&b(u[0]).css({borderStyle:"solid",
borderColor:F});(F=d.borderColor2)&&b(u[1]).css({borderStyle:"dashed",borderColor:F});m.append(S.add(u).add(ia)).append(t);T&&((F=(n.css("filter")||"").match(/opacity=(\d+)/))&&n.css("opacity",F[1]/100),(F=(u.css("filter")||"").match(/opacity=(\d+)/))&&u.css("opacity",F[1]/100));a.hide?qa(m.add(n)):a.show&&da&&(ha=!0,m.add(n).fadeIn(d.fadeSpeed||0),pa());H=(Fa=(d.aspectRatio||"").split(/:/))[0]/Fa[1];x.add(n).unbind("mousedown",Ca);if(d.disable||!1===d.enable)m.off({"mousemove touchmove":M,"mousedown touchstart":Aa}),
b(window).off("resize",Da);else{if(d.enable||!1===d.disable){if(d.resizable||d.movable)m.on({"mousemove touchmove":M,"mousedown touchstart":Aa});b(window).resize(Da)}if(!d.persistent)x.add(n).on("mousedown touchstart",Ca)}d.enable=d.disable=void 0}var x=b(z),da,m=B(),S=B(),u=B().add(B()).add(B()).add(B()),n=B().add(B()).add(B()).add(B()),t=b([]),ia,q,r,A={left:0,top:0},y,v,R,N={left:0,top:0},I=0,ea="absolute",ta,ua,X,Y,w,Z,aa,ma,na,H,ha,f,e,h,k,c={x1:0,y1:0,x2:0,y2:0,width:0,height:0},oa=document.documentElement,
D=navigator.userAgent,Fa,U,F,E,L,ra,ya=function(a){var b=d.keys,c,g=a.keyCode;c=isNaN(b.alt)||!a.altKey&&!a.originalEvent.altKey?!isNaN(b.ctrl)&&a.ctrlKey?b.ctrl:!isNaN(b.shift)&&a.shiftKey?b.shift:isNaN(b.arrows)?10:b.arrows:b.alt;if("resize"==b.arrows||"resize"==b.shift&&a.shiftKey||"resize"==b.ctrl&&a.ctrlKey||"resize"==b.alt&&(a.altKey||a.originalEvent.altKey)){switch(g){case 37:c=-c;case 39:a=l(f,h);f=p(f,h);h=l(a+c,f);ba();break;case 38:c=-c;case 40:a=l(e,k);e=p(e,k);k=l(a+c,e);ba(!0);break;
default:return}fa()}else switch(f=p(f,h),e=p(e,k),g){case 37:ca(l(f-c,q),e);break;case 38:ca(f,l(e-c,r));break;case 39:ca(f+p(c,y-J(h)),e);break;case 40:ca(f,e+p(c,v-K(k)));break;default:return}return!1};this.remove=function(){wa({disable:!0});m.add(n).remove()};this.getOptions=function(){return d};this.setOptions=wa;this.getSelection=G;this.setSelection=la;this.cancelSelection=ja;this.update=pa;for(var T=(/msie ([\w.]+)/i.exec(D)||[])[1],Ga=/opera/i.test(D),Ha=/webkit/i.test(D)&&!/chrome/i.test(D),
D=x;D.length;)I=l(I,isNaN(D.css("z-index"))?I:D.css("z-index")),"fixed"==D.css("position")&&(ea="fixed"),D=D.parent(":not(body)");I=d.zIndex||I;T&&x.attr("unselectable","on");b.imgAreaSelect.keyPress=T||Ha?"keydown":"keypress";Ga&&(ia=B().css({width:"100%",height:"100%",position:"absolute",zIndex:I+2||2}));m.add(n).css({visibility:"hidden",position:ea,overflow:"hidden",zIndex:I||"0"});m.css({zIndex:I+2||2});S.add(u).css({position:"absolute",fontSize:0});z.complete||"complete"==z.readyState||!x.is("img")?
Ea():x.one("load",Ea);!da&&T&&7<=T&&(z.src=z.src)};b.fn.imgAreaSelect=function(g){g=g||{};this.each(function(){b(this).data("imgAreaSelect")?g.remove?(b(this).data("imgAreaSelect").remove(),b(this).removeData("imgAreaSelect")):b(this).data("imgAreaSelect").setOptions(g):g.remove||(void 0===g.enable&&void 0===g.disable&&(g.enable=!0),b(this).data("imgAreaSelect",new b.imgAreaSelect(this,g)))});return g.instance?b(this).data("imgAreaSelect"):this}})(jQuery);
