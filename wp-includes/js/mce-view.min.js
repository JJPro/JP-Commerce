(function(q,f,g,h){var m={},k={};f.mce=f.mce||{};f.mce.views={register:function(a,b){m[a]=f.mce.View.extend(_.extend(b,{type:a}))},unregister:function(a){delete m[a]},get:function(a){return m[a]},unbind:function(){_.each(k,function(a){a.unbind()})},setMarkers:function(a){var b=[{content:a}],c=this,d,e;_.each(m,function(a,n){e=b.slice();b=[];_.each(e,function(t){var p=t.content,e;if(t.processed)b.push(t);else{for(;p&&(e=a.prototype.match(p));)e.index&&b.push({content:p.substring(0,e.index)}),d=c.createInstance(n,
e.content,e.options),t=d.loader?".":d.text,b.push({content:d.ignore?t:'<p data-wpview-marker="'+d.encodedText+'">'+t+"</p>",processed:!0}),p=p.slice(e.index+e.content.length);p&&b.push({content:p})}})});a=_.pluck(b,"content").join("");return a.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(a,b,c,d){a=this.get(a);b=tinymce.DOM.decode(b);if(!d&&(d=this.getInstance(b)))return d;d=encodeURIComponent(b);c=_.extend(c||{},{text:b,
encodedText:d});return k[d]=new a(c)},getInstance:function(a){return"string"===typeof a?k[encodeURIComponent(a)]:k[h(a).attr("data-wpview-text")]},getText:function(a){return decodeURIComponent(h(a).attr("data-wpview-text")||"")},render:function(a){_.each(k,function(b){b.render(a)})},update:function(a,b,c,d){var e=this.getInstance(c);e&&e.update(a,b,c,d)},edit:function(a,b){var c=this.getInstance(b);c&&c.edit&&c.edit(c.text,function(d,e){c.update(d,a,b,e)})},remove:function(a,b){var c=this.getInstance(b);
c&&c.remove(a,b)}};f.mce.View=function(a){_.extend(this,a);this.initialize()};f.mce.View.extend=Backbone.View.extend;_.extend(f.mce.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(){return this.content},render:function(a,b){null!=a&&(this.content=a);a=this.getContent();if(this.loader||a)b&&this.unbind(),this.replaceMarkers(),a?this.setContent(a,function(a,b,e){h(b).data("rendered",!0);this.bindNode.call(this,a,b,e)},b?null:!1):this.setLoader()},bindNode:function(){},
unbindNode:function(){},unbind:function(){this.getNodes(function(a,b,c){this.unbindNode.call(this,a,b,c);h(b).trigger("wp-mce-view-unbind")},!0)},getEditors:function(a){_.each(tinymce.editors,function(b){b.plugins.wpview&&a.call(this,b)},this)},getNodes:function(a,b){this.getEditors(function(c){var d=this;h(c.getBody()).find('[data-wpview-text="'+d.encodedText+'"]').filter(function(){var a;if(null==b)return!0;a=!0===h(this).data("rendered");return b?a:!a}).each(function(){a.call(d,c,this,h(this).find(".wpview-content").get(0))})})},
getMarkers:function(a){this.getEditors(function(b){var c=this;h(b.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){a.call(c,b,this)})})},replaceMarkers:function(){this.getMarkers(function(a,b){var c=b===a.selection.getNode(),d;this.loader||h(b).text()===this.text?(d=a.$('<div class="wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'"><p class="wpview-selection-before">\u00a0</p><div class="wpview-body" contenteditable="false"><div class="wpview-content wpview-type-'+
this.type+'"></div></div><p class="wpview-selection-after">\u00a0</p></div>'),a.$(b).replaceWith(d),c&&a.wp.setViewCursor(!1,d[0])):a.dom.setAttrib(b,"data-wpview-marker",null)})},removeMarkers:function(){this.getMarkers(function(a,b){a.dom.setAttrib(b,"data-wpview-marker",null)})},setContent:function(a,b,c){_.isObject(a)&&-1!==a.body.indexOf("<script")?this.setIframes(a.head||"",a.body,b,c):_.isString(a)&&-1!==a.indexOf("<script")?this.setIframes("",a,b,c):this.getNodes(function(c,e,l){a=a.body||
a;-1!==a.indexOf("<iframe")&&(a+='<div class="wpview-overlay"></div>');l.innerHTML="";l.appendChild(_.isString(a)?c.dom.createFragment(a):a);b&&b.call(this,c,e,l)},c)},setIframes:function(a,b,c,d){var e=q.MutationObserver||q.WebKitMutationObserver||q.MozMutationObserver,l=this;this.getNodes(function(n,d,p){var u=n.dom,f="",k=n.getBody().className||"",g=n.getDoc().getElementsByTagName("head")[0];tinymce.each(u.$('link[rel="stylesheet"]',g),function(a){a.href&&-1===a.href.indexOf("skins/lightgray/content.min.css")&&
-1===a.href.indexOf("skins/wordpress/wp-content.css")&&(f+=u.getOuterHTML(a))});l.iframeHeight&&u.add(p,"div",{style:{width:"100%",height:l.iframeHeight}});setTimeout(function(){function g(){var a;!w&&m.contentWindow&&(a=h(m),l.iframeHeight=h(r.body).height(),a.height()!==l.iframeHeight&&(a.height(l.iframeHeight),n.nodeChanged()))}function q(){r.body.className=n.getBody().className}var m,r,x,v,w;p.innerHTML="";m=u.add(p,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",
scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"},height:l.iframeHeight});u.add(p,"div",{"class":"wpview-overlay"});r=m.contentWindow.document;r.open();r.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+a+f+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+
k+'">'+b+"</body></html>");r.close();l.iframeHeight&&(w=!0,setTimeout(function(){w=!1;g()},3E3));h(m.contentWindow).on("load",g);if(e)x=new e(_.debounce(g,100)),x.observe(r.body,{attributes:!0,childList:!0,subtree:!0}),h(d).one("wp-mce-view-unbind",function(){x.disconnect()});else for(v=1;6>v;v++)setTimeout(g,700*v);n.on("wp-body-class-change",q);h(d).one("wp-mce-view-unbind",function(){n.off("wp-body-class-change",q)});c&&c.call(l,n,d,p)},50)},d)},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="wpview-loading"><ins></ins></div></div>')},
setError:function(a,b){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(b||"no")+'"></div><p>'+a+"</p></div>")},match:function(a){if(a=g.next(this.type,a))return{index:a.index,content:a.content,options:{shortcode:a.shortcode}}},update:function(a,b,c,d){_.find(m,function(e,l){var n=e.prototype.match(a);if(n)return h(c).data("rendered",!1),b.dom.setAttrib(c,"data-wpview-text",encodeURIComponent(a)),f.mce.views.createInstance(l,a,n.options,d).render(),b.focus(),!0})},remove:function(a,
b){this.unbindNode.call(this,a,b,h(b).find(".wpview-content").get(0));h(b).trigger("wp-mce-view-unbind");a.dom.remove(b);a.focus()}})})(window,window.wp,window.wp.shortcode,window.jQuery);
(function(q,f,g,h){function m(a){var b={};if(!q.tinymce)return a.replace(/<[^>]+>/g,"");if(!a||-1===a.indexOf("<")&&-1===a.indexOf(">"))return a;c=c||new q.tinymce.html.Schema(b);d=d||new q.tinymce.html.DomParser(b,c);e=e||new q.tinymce.html.Serializer(b,c);return e.serialize(d.parse(a,{forced_root_block:!1}))}var k,a,b,c,d,e;k={state:[],edit:function(a,b){var c=this.type,d=g[c].edit(a);this.pausePlayers&&this.pausePlayers();_.each(this.state,function(a){d.state(a).on("update",function(a){b(g[c].shortcode(a).string(),
"gallery"===c)})});d.on("close",function(){d.detach()});d.open()}};a=_.extend({},k,{state:["gallery-edit"],template:g.template("editor-gallery"),initialize:function(){var a=g.gallery.attachments(this.shortcode,g.view.settings.post.id),b=this.shortcode.attrs.named,c=this;a.more().done(function(){a=a.toJSON();_.each(a,function(a){a.sizes&&(b.size&&a.sizes[b.size]?a.thumbnail=a.sizes[b.size]:a.sizes.thumbnail?a.thumbnail=a.sizes.thumbnail:a.sizes.full&&(a.thumbnail=a.sizes.full))});c.render(c.template({verifyHTML:m,
attachments:a,columns:b.columns?parseInt(b.columns,10):g.galleryDefaults.columns}))}).fail(function(a,b){c.setError(b)})}});k=_.extend({},k,{action:"parse-media-shortcode",initialize:function(){var a=this;this.url&&(this.loader=!1,this.shortcode=g.embed.shortcode({url:this.text}));wp.ajax.post(this.action,{post_ID:g.view.settings.post.id,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(b){a.render(b)}).fail(function(b){a.url?(a.ignore=!0,a.removeMarkers()):a.setError(b.message||
b.statusText,"admin-media")});this.getEditors(function(b){b.on("wpview-selected",function(){a.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(a,b,c){(a=h("iframe.wpview-sandbox",c).get(0))&&(a=a.contentWindow)&&a.mejs&&_.each(a.mejs.players,function(a){try{a.pause()}catch(b){}})})}});b=_.extend({},k,{action:"parse-embed",edit:function(a,b){var c=g.embed.edit(a,this.url),d=this;this.pausePlayers();c.state("embed").props.on("change:url",function(a,b){b&&a.get("url")&&(c.state("embed").metadata=
a.toJSON())});c.state("embed").on("select",function(){var a=c.state("embed").metadata;d.url?b(a.url):b(g.embed.shortcode(a).string())});c.on("close",function(){c.detach()});c.open()}});f.register("gallery",_.extend({},a));f.register("audio",_.extend({},k,{state:["audio-details"]}));f.register("video",_.extend({},k,{state:["video-details"]}));f.register("playlist",_.extend({},k,{state:["playlist-edit","video-playlist-edit"]}));f.register("embed",_.extend({},b));f.register("embedURL",_.extend({},b,
{match:function(a){if(a=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi.exec(a))return{index:a.index+a[1].length,content:a[2],options:{url:!0}}}}))})(window,window.wp.mce.views,window.wp.media,window.jQuery);
