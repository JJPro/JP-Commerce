window.wp=window.wp||{};
(function(f){wp.Backbone={};wp.Backbone.Subviews=function(a,b){this.view=a;this._views=_.isArray(b)?{"":b}:b||{}};wp.Backbone.Subviews.extend=Backbone.Model.extend;_.extend(wp.Backbone.Subviews.prototype,{all:function(){return _.flatten(this._views)},get:function(a){return this._views[a||""]},first:function(a){return(a=this.get(a))&&a.length?a[0]:null},set:function(a,b,c){var d,e;_.isString(a)||(c=b,b=a,a="");c=c||{};b=_.isArray(b)?b:[b];d=this.get(a);e=b;d&&(c.add?_.isUndefined(c.at)?e=d.concat(b):
(e=d,e.splice.apply(e,[c.at,0].concat(b))):(_.each(e,function(a){a.__detach=!0}),_.each(d,function(a){a.__detach?a.$el.detach():a.remove()}),_.each(e,function(a){delete a.__detach})));this._views[a]=e;_.each(b,function(b){var c=b.Views||wp.Backbone.Subviews;b=b.views=b.views||new c(b);b.parent=this.view;b.selector=a},this);c.silent||this._attach(a,b,_.extend({ready:this._isReady()},c));return this},add:function(a,b,c){_.isString(a)||(c=b,b=a,a="");return this.set(a,b,_.extend({add:!0},c))},unset:function(a,
b,c){var d;_.isString(a)||(c=b,b=a,a="");b=b||[];if(d=this.get(a))b=_.isArray(b)?b:[b],this._views[a]=b.length?_.difference(d,b):[];c&&c.silent||_.invoke(b,"remove");return this},detach:function(){f(_.pluck(this.all(),"el")).detach();return this},render:function(){var a={ready:this._isReady()};_.each(this._views,function(b,c){this._attach(c,b,a)},this);this.rendered=!0;return this},remove:function(a){a&&a.silent||(this.parent&&this.parent.views&&this.parent.views.unset(this.selector,this.view,{silent:!0}),
delete this.parent,delete this.selector);_.invoke(this.all(),"remove");this._views=[];return this},replace:function(a,b){a.html(b);return this},insert:function(a,b,c){c=c&&c.at;var d;_.isNumber(c)&&(d=a.children()).length>c?d.eq(c).before(b):a.append(b);return this},ready:function(){this.view.trigger("ready");_.chain(this.all()).map(function(a){return a.views}).flatten().where({attached:!0}).invoke("ready")},_attach:function(a,b,c){a=a?this.view.$(a):this.view.$el;var d;if(!a.length)return this;d=
_.chain(b).pluck("views").flatten().value();_.each(d,function(a){a.rendered||(a.view.render(),a.rendered=!0)},this);this[c.add?"insert":"replace"](a,_.pluck(b,"el"),c);_.each(d,function(a){a.attached=!0;c.ready&&a.ready()},this);return this},_isReady:function(){for(var a=this.view.el;a;){if(a===document.body)return!0;a=a.parentNode}return!1}});wp.Backbone.View=Backbone.View.extend({Subviews:wp.Backbone.Subviews,constructor:function(a){this.views=new this.Subviews(this,this.views);this.on("ready",
this.ready,this);this.options=a||{};Backbone.View.apply(this,arguments)},remove:function(){var a=Backbone.View.prototype.remove.apply(this,arguments);this.views&&this.views.remove();return a},render:function(){var a;this.prepare&&(a=this.prepare());this.views.detach();this.template&&(a=a||{},this.trigger("prepare",a),this.$el.html(this.template(a)));this.views.render();return this},prepare:function(){return this.options},ready:function(){}})})(jQuery);
