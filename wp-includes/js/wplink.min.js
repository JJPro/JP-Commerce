var wpLink;
(function(e){var f,p,l,n,m,b={},h,k,q,r="ontouchend"in document;wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",init:function(){b.wrap=e("#wp-link-wrap");b.dialog=e("#wp-link");b.backdrop=e("#wp-link-backdrop");b.submit=e("#wp-link-submit");b.close=e("#wp-link-close");b.text=e("#wp-link-text");b.url=e("#wp-link-url");b.nonce=e("#_ajax_linking_nonce");b.openInNewTab=e("#wp-link-target");b.search=e("#wp-link-search");h=new l(e("#search-results"));
k=new l(e("#most-recent-results"));q=b.dialog.find(".query-results");b.queryNotice=e("#query-notice-message");b.queryNoticeTextDefault=b.queryNotice.find(".query-notice-default");b.queryNoticeTextHint=b.queryNotice.find(".query-notice-hint");b.dialog.keydown(wpLink.keydown);b.dialog.keyup(wpLink.keyup);b.submit.click(function(a){a.preventDefault();wpLink.update()});b.close.add(b.backdrop).add("#wp-link-cancel a").click(function(a){a.preventDefault();wpLink.close()});e("#wp-link-search-toggle").on("click",
wpLink.toggleInternalLinking);q.on("river-select",wpLink.updateFields);b.search.on("focus.wplink",function(){b.queryNoticeTextDefault.hide();b.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){b.queryNoticeTextDefault.show();b.queryNoticeTextHint.addClass("screen-reader-text").hide()});b.search.on("keyup input",function(){var a=this;window.clearTimeout(p);p=window.setTimeout(function(){wpLink.searchInternalLinks.call(a)},500)});b.url.on("paste",function(){setTimeout(wpLink.correctURL,
0)});b.url.on("blur",wpLink.correctURL)},correctURL:function(){var a=e.trim(b.url.val());a&&m!==a&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(a)&&(b.url.val("http://"+a),m=a)},open:function(a){var c=e(document.body);c.addClass("modal-open");wpLink.range=null;a&&(window.wpActiveEditor=a);window.wpActiveEditor&&(this.textarea=e("#"+window.wpActiveEditor).get(0),"undefined"!==typeof tinymce&&(c.append(b.backdrop,b.wrap),(f=(a=tinymce.get(wpActiveEditor))&&!a.isHidden()?a:null)&&tinymce.isIE&&(f.windowManager.bookmark=
f.selection.getBookmark())),!wpLink.isMCE()&&document.selection&&(this.textarea.focus(),this.range=document.selection.createRange()),b.wrap.show(),b.backdrop.show(),wpLink.refresh(),e(document).trigger("wplink-open",b.wrap))},isMCE:function(){return f&&!f.isHidden()},refresh:function(){var a="";h.refresh();k.refresh();wpLink.isMCE()?wpLink.mceRefresh():(b.wrap.hasClass("has-text-field")||b.wrap.addClass("has-text-field"),document.selection?a=document.selection.createRange().text||"":"undefined"!==
typeof this.textarea.selectionStart&&this.textarea.selectionStart!==this.textarea.selectionEnd&&(a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||""),b.text.val(a),wpLink.setDefaultValues());r?b.url.focus().blur():b.url.focus()[0].select();k.ul.children().length||k.ajax();m=b.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(a){var c=f.selection.getContent();if(/</.test(c)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(c)||-1===c.indexOf("href=")))return!1;if(a){a=
a.childNodes;if(0===a.length)return!1;for(c=a.length-1;0<=c;c--)if(3!=a[c].nodeType)return!1}return!0},mceRefresh:function(){var a;a=f.selection.getNode();var c=f.dom.getParent(a,"a[href]"),d=this.hasSelectedText(c);c?(a=c.innerText||c.textContent,b.url.val(f.dom.getAttrib(c,"href")),b.openInNewTab.prop("checked","_blank"===f.dom.getAttrib(c,"target")),b.submit.val(wpLinkL10n.update)):(a=f.selection.getContent({format:"text"}),this.setDefaultValues());d?(b.text.val(a||""),b.wrap.addClass("has-text-field")):
(b.text.val(""),b.wrap.removeClass("has-text-field"))},close:function(){e(document.body).removeClass("modal-open");wpLink.isMCE()?f.focus():(wpLink.textarea.focus(),wpLink.range&&(wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select()));b.backdrop.hide();b.wrap.hide();m=!1;e(document).trigger("wplink-close",b.wrap)},getAttrs:function(){wpLink.correctURL();return{href:e.trim(b.url.val()),target:b.openInNewTab.prop("checked")?"_blank":""}},buildHtml:function(a){var c='<a href="'+
a.href+'"';a.target&&(c+=' target="'+a.target+'"');return c+">"},update:function(){wpLink.isMCE()?wpLink.mceUpdate():wpLink.htmlUpdate()},htmlUpdate:function(){var a,c,d,e,f,g=wpLink.textarea;g&&(a=wpLink.getAttrs(),c=b.text.val(),a.href&&(a=wpLink.buildHtml(a),document.selection&&wpLink.range?(g.focus(),wpLink.range.text=a+(c||wpLink.range.text)+"</a>",wpLink.range.moveToBookmark(wpLink.range.getBookmark()),wpLink.range.select(),wpLink.range=null):"undefined"!==typeof g.selectionStart&&(d=g.selectionStart,
e=g.selectionEnd,f=c||g.value.substring(d,e),a=a+f+"</a>",c=d+a.length,d!==e||f||(c-=4),g.value=g.value.substring(0,d)+a+g.value.substring(e,g.value.length),g.selectionStart=g.selectionEnd=c),wpLink.close(),g.focus()))},mceUpdate:function(){var a=wpLink.getAttrs(),c,d;wpLink.close();f.focus();tinymce.isIE&&f.selection.moveToBookmark(f.windowManager.bookmark);a.href?(c=f.dom.getParent(f.selection.getNode(),"a"),b.wrap.hasClass("has-text-field")&&(d=b.text.val()||a.href),c?(d&&("innerText"in c?c.innerText=
d:c.textContent=d),f.dom.setAttribs(c,a)):d?f.selection.setNode(f.dom.create("a",a,f.dom.encode(d))):f.execCommand("mceInsertLink",!1,a),f.nodeChanged()):f.execCommand("unlink")},updateFields:function(a,c){b.url.val(c.children(".item-permalink").val())},setDefaultValues:function(){var a,c=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i,d=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,4}[^ "]*$/i;this.isMCE()?a=f.selection.getContent():document.selection&&wpLink.range?a=wpLink.range.text:"undefined"!==typeof this.textarea.selectionStart&&
(a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd));a&&c.test(a)?b.url.val("mailto:"+a):a&&d.test(a)?b.url.val(a.replace(/&amp;|&#0?38;/gi,"&")):b.url.val("");b.submit.val(wpLinkL10n.save)},searchInternalLinks:function(){var a=e(this),c,b=a.val();2<b.length?(k.hide(),h.show(),wpLink.lastSearch!=b&&(wpLink.lastSearch=b,c=a.parent().find(".spinner").addClass("is-active"),h.change(b),h.ajax(function(){c.removeClass("is-active")}))):(h.hide(),k.show())},next:function(){h.next();
k.next()},prev:function(){h.prev();k.prev()},keydown:function(a){var c;27===a.keyCode?(wpLink.close(),a.stopImmediatePropagation()):9===a.keyCode&&((c=a.target.id,"wp-link-submit"!==c||a.shiftKey)?"wp-link-close"===c&&a.shiftKey&&(b.submit.focus(),a.preventDefault()):(b.close.focus(),a.preventDefault()));if(38===a.keyCode||40===a.keyCode)if(!document.activeElement||"link-title-field"!==document.activeElement.id&&"url-field"!==document.activeElement.id)c=38===a.keyCode?"prev":"next",clearInterval(wpLink.keyInterval),
wpLink[c](),wpLink.keyInterval=setInterval(wpLink[c],wpLink.keySensitivity),a.preventDefault()},keyup:function(a){if(38===a.keyCode||40===a.keyCode)clearInterval(wpLink.keyInterval),a.preventDefault()},delayedCallback:function(a,c){var b,e,f,g;if(!c)return a;setTimeout(function(){if(e)return a.apply(g,f);b=!0},c);return function(){if(b)return a.apply(this,arguments);f=arguments;g=this;e=!0}},toggleInternalLinking:function(a){var c=b.wrap.hasClass("search-panel-visible");b.wrap.toggleClass("search-panel-visible",
!c);setUserSetting("wplink",c?"0":"1");b[c?"url":"search"].focus();a.preventDefault()}};l=function(a,b){var d=this;this.element=a;this.ul=a.children("ul");this.contentHeight=a.children("#link-selector-height");this.waiting=a.find(".river-waiting");this.change(b);this.refresh();e("#wp-link .query-results, #wp-link #link-selector").scroll(function(){d.maybeLoad()});a.on("click","li",function(a){d.select(e(this),a)})};e.extend(l.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},
show:function(){this.visible||(this.deselect(),this.element.show(),this.visible=!0)},hide:function(){this.element.hide();this.visible=!1},select:function(a,b){var d,e,f,g;a.hasClass("unselectable")||a==this.selected||(this.deselect(),this.selected=a.addClass("selected"),d=a.outerHeight(),e=this.element.height(),f=a.position().top,g=this.element.scrollTop(),0>f?this.element.scrollTop(g+f):f+d>e&&this.element.scrollTop(g+f-e+d),this.element.trigger("river-select",[a,b,this]))},deselect:function(){this.selected&&
this.selected.removeClass("selected");this.selected=!1},prev:function(){if(this.visible){var a;this.selected&&(a=this.selected.prev("li"),a.length&&this.select(a))}},next:function(){if(this.visible){var a=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);a.length&&this.select(a)}},ajax:function(a){var b=this,d=wpLink.delayedCallback(function(d,e){b.process(d,e);a&&a(d,e)},1==this.query.page?0:wpLink.minRiverAJAXDuration);this.query.ajax(d)},change:function(a){this.query&&
this._search==a||(this._search=a,this.query=new n(a),this.element.scrollTop(0))},process:function(a,b){var d="",f=!0,h="",g=1==b.page;a?e.each(a,function(){h=f?"alternate":"";h+=this.title?"":" no-title";d+=h?'<li class="'+h+'">':"<li>";d+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';d+='<span class="item-title">';d+=this.title?this.title:wpLinkL10n.noTitle;d+='</span><span class="item-info">'+this.info+"</span></li>";f=!f}):g&&(d+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+
wpLinkL10n.noMatchesFound+"</em></span></li>");this.ul[g?"html":"append"](d)},maybeLoad:function(){var a=this,b=this.element,d=b.scrollTop()+b.height();!this.query.ready()||d<this.contentHeight.height()-wpLink.riverBottomThreshold||setTimeout(function(){var d=b.scrollTop(),e=d+b.height();!a.query.ready()||e<a.contentHeight.height()-wpLink.riverBottomThreshold||(a.waiting.addClass("is-active"),b.scrollTop(d+a.waiting.outerHeight()),a.ajax(function(){a.waiting.removeClass("is-active")}))},wpLink.timeToTriggerRiver)}});
n=function(a){this.page=1;this.querying=this.allLoaded=!1;this.search=a};e.extend(n.prototype,{ready:function(){return!(this.querying||this.allLoaded)},ajax:function(a){var c=this,d={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:b.nonce.val()};this.search&&(d.search=this.search);this.querying=!0;e.post(ajaxurl,d,function(b){c.page++;c.querying=!1;c.allLoaded=!b;a(b,d)},"json")}});e(document).ready(wpLink.init)})(jQuery);
